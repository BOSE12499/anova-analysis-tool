<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <meta name="msapplication-navbutton-color" content="#2563eb">
    <meta name="apple-mobile-web-app-title" content="Statistics Analysis">
    <title>Statistics Analysis</title>
    <!-- Font Awesome 6.5.1 - Latest stable version to fix SVG path issues -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer">
    
    
    <style>
        /* JMP-Style CSS Variables for Professional Statistical Interface */
        :root {
            /* Clean Modern Colors - Matching the screenshot */
            --primary-color: #4A90E2;
            --secondary-color: #6C757D;
            --accent-color: #4A90E2;
            --success-color: #28A745;
            --warning-color: #FFC107;
            --error-color: #DC3545;
            
            /* Clean Light Theme - Like the image */
            --bg-primary: #F5F6FA;        /* Light gray background */
            --bg-secondary: #FFFFFF;      /* Pure white */
            --bg-card: #FFFFFF;           /* White cards */
            --bg-input: #FFFFFF;          /* White inputs */
            --text-primary: #2C3E50;      /* Dark text */
            --text-secondary: #6C757D;    /* Gray text */
            --border-color: #E9ECEF;      /* Light border */
            --accent-color-alpha: rgba(74, 144, 226, 0.1);
            
            /* Modern Shadows */
            --shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 4px 12px rgba(0, 0, 0, 0.08);
            --radius: 8px;
            --radius-lg: 12px;
            --transition: all 0.2s ease;
            
            /* Dynamic Responsive Variables */
            --screen-width: 100vw;
            --screen-height: 100vh;
            --base-font-size: 16px;
            --heading-scale: 1.0;
            --device-type: 'desktop';
            
            /* Dynamic Spacing */
            --container-padding: calc(var(--screen-width) * 0.02);
            --card-padding: calc(var(--screen-width) * 0.015);
            --element-margin: calc(var(--screen-width) * 0.01);
        }

        /* Dark Mode Theme */
        [data-theme="dark"] {
            --primary-color: #6A9BDC;
            --secondary-color: #8E8E93;
            --accent-color: #6A9BDC;
            --success-color: #34C759;
            --warning-color: #FF9500;
            --error-color: #FF3B30;
            
            /* Dark backgrounds */
            --bg-primary: #1C1C1E;
            --bg-secondary: #2C2C2E;
            --bg-card: #2C2C2E;
            --bg-input: #3A3A3C;
            --text-primary: #FFFFFF;
            --text-secondary: #8E8E93;
            --border-color: #48484A;
            --accent-color-alpha: rgba(106, 155, 220, 0.1);
            
            --shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        /* Fixed Header */
        .fixed-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-color);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-logo i {
            font-size: 1.3rem;
        }

        .header-title {
            display: none; /* Hide the subtitle completely */
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        /* Theme toggle styles removed */

        /* Header Responsive */
        @media (max-width: 768px) {
            .header-content {
                padding: 12px 15px;
            }

            .header-logo {
                font-size: 1.5rem;
            }

            .header-logo i {
                font-size: 1.3rem;
            }

            .header-title {
                font-size: 0.9rem;
                display: none; /* Hide subtitle on mobile */
            }

            /* Theme toggle responsive styles removed */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
            min-height: 100vh;
            padding-top: 70px; /* Add padding for fixed header */
            font-size: var(--base-font-size);
            transition: var(--transition);
        }

        /* Dynamic Body Classes for Different Devices */
        body.mobile-xs {
            font-size: 14px;
            padding-top: 100px;
        }

        body.mobile-sm {
            font-size: 14px;
            padding-top: 95px;
        }

        body.tablet-md {
            font-size: 15px;
            padding-top: 85px;
        }

        body.tablet-lg {
            font-size: 16px;
            padding-top: 80px;
        }

        body.desktop-xl,
        body.desktop-xxl {
            font-size: 16px;
            padding-top: 80px;
        }

        /* Sidebar Styles */
        .sidebar {
            position: fixed;
            top: 0;
            left: -280px; /* Hidden by default */
            width: 280px;
            height: 100vh;
            background: var(--bg-secondary);
            border-right: 2px solid var(--border-color);
            border-top: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.15), var(--shadow-lg);
            z-index: 1000;
            transition: left 0.3s ease;
            overflow-y: auto;
            margin: 0;
            padding: 0;
        }

        .sidebar.open {
            left: 0 !important; /* Show sidebar - force to edge */
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 2px solid var(--border-color);
            background: var(--bg-card);
        }

        .sidebar-header h3 {
            margin: 0;
            color: var(--text-primary);
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sidebar-content {
            padding: 20px 0;
        }

        .sidebar-menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar-menu-item {
            margin: 0;
        }

        .sidebar-menu-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            color: var(--text-secondary);
            text-decoration: none;
            transition: var(--transition);
            border: 1px solid transparent;
            border-radius: 8px;
            background: none;
            width: 100%;
            text-align: left;
            cursor: pointer;
            margin: 2px 8px;
        }

        .sidebar-menu-link:hover {
            background: var(--accent-color-alpha);
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }

        .sidebar-menu-link.active {
            background: var(--accent-color-alpha);
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
            border-right: 3px solid var(--primary-color);
        }

        .sidebar-menu-icon {
            width: 20px;
            text-align: center;
        }

        /* Hamburger Menu Button */
        .sidebar-toggle {
            background: transparent;
            border: none;
            border-radius: var(--radius);
            padding: 8px;
            cursor: pointer;
            transition: var(--transition);
            color: var(--text-primary);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            margin-right: 10px;
        }

        .sidebar-toggle:hover {
            background: var(--accent-color-alpha);
            color: var(--primary-color);
            border-radius: var(--radius);
        }

        .sidebar-toggle:active {
            transform: scale(0.95);
        }

        /* Responsive adjustments for sidebar toggle */
        @media (max-width: 768px) {
            .sidebar-toggle {
                width: 36px;
                height: 36px;
                font-size: 14px;
                margin-right: 8px;
            }
        }

        /* Overlay for mobile */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .sidebar-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        /* Adjust main content when sidebar is open (desktop) */
        .main-content {
            transition: margin-left 0.3s ease;
        }

        .main-content.shifted {
            margin-left: 280px;
        }

        /* Responsive sidebar */
        @media (max-width: 768px) {
            .sidebar {
                width: 280px; /* Keep same width as desktop for consistency */
                left: -280px; /* Match the width for complete hiding */
            }
            
            .main-content.shifted {
                margin-left: 0; /* No shift on mobile */
            }
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--accent-color);
            border-radius: 3px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: max(20px, var(--container-padding));
            padding-top: 20px; /* Remove extra top padding since body has it */
            transition: var(--transition);
        }

        /* Dynamic Container Adjustments */
        body.mobile-xs .container {
            padding: 10px 8px;
            max-width: 100%;
        }

        body.mobile-sm .container {
            padding: 12px 10px;
            max-width: 100%;
        }

        body.tablet-md .container {
            padding: 15px 12px;
            max-width: 100%;
        }

        body.tablet-lg .container {
            padding: 18px 15px;
            max-width: 1000px;
        }

        body.desktop-xl .container {
            padding: 20px;
            max-width: 1200px;
        }

        body.desktop-xxl .container {
            padding: 30px;
            max-width: 1400px;
        }

        /* JMP-Style Header - Clean, Professional */
        .header {
            text-align: center;
            margin-bottom: 24px;
        }

        .header h1 {
            font-size: calc(2rem * var(--heading-scale));
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 6px;
            transition: var(--transition);
        }

        .header .subtitle {
            font-size: calc(1rem * var(--heading-scale));
            color: var(--text-secondary);
            max-width: 600px;
            margin: 0 auto;
            white-space: nowrap;
            transition: var(--transition);
        }

        /* Dynamic Header Adjustments */
        body.mobile-xs .header h1 {
            font-size: 1.6rem;
            line-height: 1.2;
        }

        body.mobile-xs .header .subtitle {
            font-size: 0.85rem;
            white-space: normal;
            max-width: none;
        }

        body.mobile-sm .header h1 {
            font-size: 1.8rem;
        }

        body.mobile-sm .header .subtitle {
            font-size: 0.9rem;
            white-space: normal;
        }

        body.tablet-md .header h1 {
            font-size: 2rem;
        }

        body.tablet-md .header .subtitle {
            font-size: 1rem;
        }

        body.tablet-lg .header h1 {
            font-size: 2.2rem;
        }

        body.desktop-xxl .header h1 {
            font-size: 2.8rem;
        }

        body.desktop-xxl .header .subtitle {
            font-size: 1.2rem;
        }

        /* JMP-Style Cards - Clean, Flat Design */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: max(20px, var(--card-padding));
            margin-bottom: max(20px, var(--element-margin));
            box-shadow: none;
            transition: var(--transition);
        }

        .card:hover {
            border-color: var(--accent-color);
            box-shadow: var(--shadow);
        }

        /* Dynamic Card Adjustments */
        body.mobile-xs .card {
            padding: 15px;
            margin-bottom: 12px;
            border-radius: 8px;
        }

        body.mobile-sm .card {
            padding: 16px;
            margin-bottom: 14px;
        }

        body.tablet-md .card {
            padding: 18px;
            margin-bottom: 16px;
        }

        body.tablet-lg .card {
            padding: 20px;
            margin-bottom: 18px;
        }

        body.desktop-xl .card {
            padding: 24px;
            margin-bottom: 24px;
        }

        body.desktop-xxl .card {
            padding: 28px;
            margin-bottom: 28px;
        }

        /* Upload Section */
        .upload-area {
            border: 2px dashed var(--border-color);
            border-radius: var(--radius);
            padding: 32px 16px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            margin-bottom: 24px;
            position: relative;
        }

        .upload-area:hover,
        .upload-area.dragover {
            border-color: var(--accent-color);
            background: rgba(14, 165, 233, 0.05);
        }

        /* Prevent double clicks on upload area */
        .upload-area .btn {
            position: relative;
            z-index: 2;
            pointer-events: auto;
        }

        .file-input {
            position: absolute;
            opacity: 0;
            pointer-events: none;
            z-index: -1;
        }

        .upload-icon {
            font-size: 2.5rem;
            color: var(--accent-color);
            margin-bottom: 12px;
        }

        .upload-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 6px;
        }

        /* Input Tabs */
        .input-tabs {
            display: flex;
            margin-bottom: 24px;
            border-bottom: 2px solid var(--border-color);
        }

        .tab-button {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border: none;
            padding: 12px 24px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            border-radius: 8px 8px 0 0;
            margin-right: 4px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tab-button:hover {
            background: var(--accent-color);
            color: white;
        }

        .tab-button.active {
            background: var(--primary-color);
            color: white;
            border-bottom: 2px solid var(--primary-color);
        }

        .input-tab {
            display: none;
        }

        .input-tab.active {
            display: block;
        }

        /* Text Input Area */
        .text-input-area {
            border: 2px dashed var(--border-color);
            border-radius: var(--radius);
            padding: 24px;
            text-align: center;
        }

        .format-options {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 16px 0;
            flex-wrap: wrap;
        }

        .format-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .format-option input[type="radio"] {
            accent-color: var(--primary-color);
        }

        #dataTextArea {
            width: 100%;
            min-height: 300px;
            padding: 16px 16px 16px 0; /* ลบ padding ซ้ายออกเลย (0px) */
            border: 2px solid var(--border-color);
            border-radius: var(--radius);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-family: 'JetBrains Mono', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.4;
            resize: vertical;
            margin: 16px 0;
            white-space: nowrap;
            overflow-x: auto;
            overflow-y: auto;
            text-indent: 0 !important; /* บังคับไม่ให้เยื้องข้อความ */
            text-align: left !important; /* บังคับให้ข้อความชิดซ้าย */
            padding-left: 0 !important; /* บังคับให้ไม่มี padding ซ้าย */
            margin-left: 0 !important; /* บังคับไม่ให้มี margin ซ้าย */
            box-sizing: border-box;
        }

        #dataTextArea:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .text-controls {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 16px;
            flex-wrap: wrap;
        }

        .data-preview {
            margin-top: 20px;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
            text-align: left;
        }

        .data-preview.hidden {
            display: none;
        }

        .data-preview h4 {
            margin-bottom: 12px;
            color: var(--accent-color);
        }

        .preview-table {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 12px;
        }

        .preview-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-top: 12px;
        }

        .stat-item {
            background: var(--bg-primary);
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Responsive adjustments for text input */
        @media (max-width: 768px) {
            .format-options {
                flex-direction: column;
                gap: 12px;
            }
            
            .text-controls {
                flex-direction: column;
            }
        }

        .upload-subtitle {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 16px;
        }

        /* JMP-Style Buttons - Clean, Professional */
        .btn {
            background: var(--primary-color);
            color: white;
            border: 1px solid var(--primary-color);
            padding: 8px 16px;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: var(--transition);
            box-shadow: none;
            min-height: 32px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .btn:hover:not(:disabled) {
            background: #2F5BB7;
            border-color: #2F5BB7;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Dynamic Button Adjustments */
        body.mobile-xs .btn {
            font-size: 0.75rem;
            padding: 8px 12px;
            min-height: 36px;
            gap: 4px;
        }

        body.mobile-sm .btn {
            font-size: 0.8rem;
            padding: 9px 14px;
            min-height: 38px;
            gap: 5px;
        }

        body.tablet-md .btn {
            font-size: 0.85rem;
            padding: 10px 16px;
            min-height: 40px;
        }

        body.tablet-lg .btn {
            font-size: 0.9rem;
            padding: 11px 20px;
            min-height: 42px;
        }

        body.desktop-xl .btn {
            font-size: 0.95rem;
            padding: 12px 24px;
            min-height: 44px;
        }

        body.desktop-xxl .btn {
            font-size: 1rem;
            padding: 14px 28px;
            min-height: 48px;
        }

        .btn-accent {
            background: var(--accent-color);
        }

        .btn-accent:hover:not(:disabled) {
            background: #0284c7;
        }


        /* Secondary Button (Export) */
        .btn-secondary {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            box-shadow: var(--shadow);
        }
        .btn-secondary:hover:not(:disabled) {
            background: var(--accent-color);
            color: white;
            box-shadow: var(--shadow-lg);
        }

        .btn-export {
            background: var(--success-color);
            color: white;
        }

        .btn-export:hover {
            background: #059669;
            transform: translateY(-1px);
        }

        .dashboard-action {
            animation: slideInUp 0.5s ease-out;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Input Groups */
        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .input-group {
            text-align: left;
        }

        .input-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .input-group input[type="number"] {
            width: 100%;
            max-width: 200px;
            padding: 6px 8px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            color: var(--text-primary);
            font-size: 0.9rem;
            transition: var(--transition);
        }

        .input-group input[type="number"]:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: none;
        }

        /* JMP-Style Table Names Section */
        .table-names-section {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 16px;
            margin: 16px 0;
            box-shadow: none;
        }

        .table-names-section h3 {
            color: var(--accent-color);
            margin-bottom: 8px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-description {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 20px;
            line-height: 1.4;
        }

        .table-names-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }

        .table-names-section-compact {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            margin-top: 8px;
            margin-bottom: 20px;
        }

        .compact-suffix-input {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .compact-suffix-input label {
            font-size: 0.9rem;
            color: var(--text-primary);
            margin: 0;
            font-weight: 500;
        }

        .suffix-input-compact {
            width: 100%;
            max-width: 400px;
            padding: 8px 12px;
            font-size: 0.9rem;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            transition: border-color 0.2s ease;
        }

        .suffix-input-compact:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px var(--accent-color-alpha);
        }

        .suffix-input-compact::placeholder {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .name-input-group {
            display: flex;
            flex-direction: column;
        }

        .name-input-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .name-input-group input[type="text"] {
            width: 100%;
            padding: 6px 8px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            color: var(--text-primary);
            font-size: 0.9rem;
            transition: var(--transition);
        }

        .name-input-group input[type="text"]:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: none;
        }

        .name-input-group input[type="text"]::placeholder {
            color: var(--text-secondary);
            opacity: 0.7;
        }

        /* JMP-Style Sample Section */
        .sample-section {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 16px;
            margin-top: 16px;
            margin-bottom: 16px;
        }

        .sample-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--accent-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sample-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        @media (max-width: 768px) {
            .sample-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
        }

        .sample-example,
        .sample-tips {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 16px;
            box-shadow: var(--shadow);
        }

        .pre-formatted {
            font-family: 'Courier New', monospace;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 12px;
            white-space: pre;
            font-size: 0.85rem;
            color: var(--text-secondary);
            overflow-x: auto;
        }

        /* Basic Information Table Styles - ขนาดเล็กและกะทัดรัด */
        .basic-info-table {
            width: 100%;
            margin-bottom: 16px;
        }

        .info-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
            background: var(--bg-card);
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: none;
            border: 1px solid var(--border-color);
        }

        .info-table td {
            padding: 8px 12px;
            border-bottom: 1px solid var(--border-color);
            border-right: 1px solid var(--border-color);
            vertical-align: middle;
            transition: background-color 0.2s ease;
        }

        .info-table tr:last-child td {
            border-bottom: none;
        }

        .info-table tr:nth-child(odd) {
            background: #FFFFFF;
        }
        
        .info-table tr:nth-child(even) {
            background: #F8F9FA;
        }

        .info-table tr:hover {
            background: #E3F2FD !important;
            transition: all 0.3s ease;
        }

        .info-label {
            background: var(--bg-secondary);
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.6px;
            min-width: 160px;
            width: 40%;
            border-right: 2px solid var(--border-color);
            position: relative;
        }

        .info-label::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--border-color);
            border-radius: 0 1px 1px 0;
        }

        .info-label i {
            margin-right: 8px;
            color: #0ea5e9;
            font-size: 0.9rem;
            width: 16px;
            text-align: center;
        }

        .info-value {
            color: var(--text-primary);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-weight: 500;
            font-size: 0.8rem;
            background: var(--bg-card);
            padding-left: 16px;
        }

        /* ปรับสีให้อ่อนลงสำหรับ LOT count rows */
        .info-table tr:nth-child(n+4) .info-label {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border-right-color: var(--border-color);
        }

        .info-table tr:nth-child(n+4) .info-label::before {
            background: var(--border-color);
        }

        .info-table tr:nth-child(n+4) .info-label i {
            color: #0ea5e9;
        }

        .info-table tr:nth-child(n+4) .info-value {
            background: var(--bg-card);
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Enhanced visual hierarchy แบบกะทัดรัด */
        .info-table tr:first-child td {
            padding-top: 12px;
        }

        .info-table tr:last-child td {
            padding-bottom: 12px;
        }

        /* Add subtle animations */
        .info-table {
            animation: slideInUp 0.6s ease-out;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Responsive enhancements - ขนาดเล็ก */
        @media (max-width: 768px) {
            .info-table td {
                padding: 8px 12px;
                font-size: 0.75rem;
            }

            .info-label {
                min-width: 120px;
                width: 45%;
                font-size: 0.7rem;
            }

            .info-label i {
                margin-right: 6px;
                font-size: 0.8rem;
            }

            .info-value {
                padding-left: 12px;
                font-size: 0.75rem;
            }
        }

        .tips-list {
            list-style-type: none;
            padding-left: 0;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .tips-list li {
            margin-bottom: 8px;
            position: relative;
            padding-left: 20px;
        }

        .tips-list li:before {
            content: '✓';
            position: absolute;
            left: 0;
            color: var(--success-color);
            font-weight: bold;
        }

        /* Enhanced Results Section */
        .results-section {
            display: none;
            margin-top: 40px;
        }

        .results-section.visible {
            display: block;
            animation: slideInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideInUp {
            from { 
                opacity: 0; 
                transform: translateY(60px) scale(0.95);
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1);
            }
        }

        /* JMP-Style Result Cards */
        .result-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-left: 3px solid var(--accent-color);
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow);
            transition: var(--transition);
            position: relative;
            overflow: visible;
        }

        .result-card:hover {
            border-color: var(--accent-color);
            box-shadow: var(--shadow-lg);
        }
        
        .result-card h3 {
            color: var(--text-primary);
            margin-bottom: 16px;
            font-size: 1.2rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .result-title {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.9rem;
        }
        
        .result-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-color);
            margin-bottom: 0.5rem;
            color: var(--primary-color);
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px 20px;
        }
        
        .loading-text {
            color: var(--text-secondary);
        }

        .spinner {
            width: 40px;
            height: 40px;
            margin: 0 auto 16px;
            border: 3px solid var(--border-color);
            border-top: 3px solid var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
            margin: 16px 0;
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
        }

        /* JMP-Style Statistical Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            border: 1px solid var(--border-color);
        }

        th, td {
            padding: 6px 12px;
            text-align: left;
            border-right: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background: #E7F3FF;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.85rem;
            text-transform: none;
            letter-spacing: normal;
        }

        /* JMP-style alternating row colors */
        tbody tr:nth-child(odd) {
            background: #FFFFFF;
        }
        
        tbody tr:nth-child(even) {
            background: #F8F9FA;
        }

        tr:hover {
            background: #E3F2FD !important;
        }

        /* Compact Table for Confidence Quantile - สไตล์เหมือนตารางอื่นๆ */
        .compact-table-container {
            margin: 16px 0;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            display: inline-block;
            min-width: 250px;
            max-width: 300px;
            background: var(--bg-card);
        }

        .compact-quantile-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
            background: transparent;
        }

        .compact-quantile-table th {
            background: #E7F3FF;
            color: var(--text-primary);
            padding: 6px 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            border-right: 1px solid var(--border-color);
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: none;
            letter-spacing: normal;
        }

        .compact-quantile-table td {
            padding: 6px 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            border-right: 1px solid var(--border-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: var(--text-primary);
        }

        .compact-quantile-table tbody tr:nth-child(odd) {
            background: #FFFFFF;
        }
        
        .compact-quantile-table tbody tr:nth-child(even) {
            background: #F8F9FA;
        }

        .compact-quantile-table tbody tr:hover {
            background: #E3F2FD !important;
        }

        /* Charts */
        .chart-container {
            margin: 16px 0;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
            text-align: center;
        }

        .chart-container img {
            max-width: 100%;
            height: auto;
            border-radius: var(--radius);
        }

        /* Messages */
        .message {
            padding: 12px 16px;
            border-radius: var(--radius);
            margin: 12px 0;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .error {
            background: rgba(239, 68, 68, 0.1);
            color: #fca5a5;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .success {
            background: rgba(16, 185, 129, 0.1);
            color: #6ee7b7;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .warning {
            background: rgba(245, 158, 11, 0.1);
            color: #fbbf24;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        /* Interpretation */
        .interpretation {
            background: rgba(37, 99, 235, 0.1);
            border: 1px solid rgba(37, 99, 235, 0.3);
            color: var(--text-primary);
            padding: 16px;
            border-radius: var(--radius);
            margin: 16px 0;
        }

        .interpretation h4 {
            margin-bottom: 8px;
            font-size: 1rem;
            color: var(--accent-color);
        }

        /* File Display */
        #fileNameDisplay {
            margin-top: 12px;
            font-weight: 500;
            color: var(--accent-color);
            font-size: 0.9rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }

            .card {
                padding: 16px;
                margin-bottom: 16px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .upload-area {
                padding: 24px 12px;
            }

            .btn {
                width: 100%;
                margin-bottom: 12px;
            }

            .input-group input[type="number"] {
                max-width: 100%;
            }

            .input-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            /* Fixed Header */
            .fixed-header {
                padding: 10px 0;
            }

            .header-content {
                flex-direction: column;
                align-items: flex-start;
            }

            .header-logo {
                margin-bottom: 8px;
            }

            .header-title {
                display: block;
                font-size: 0.9rem;
                text-align: center;
            }

            .header-right {
                width: 100%;
                justify-content: space-between;
                margin-top: 8px;
            }

            /* Theme toggle responsive removed */
        }

        /* Enhanced Responsive Design for All Devices - Same as dashboard.html */
        
        /* Extra Large Desktops (1400px+) */
        @media (min-width: 1400px) {
            .container {
                max-width: 1400px;
                padding: 30px;
            }
            
            .upload-section,
            .results-section {
                padding: 30px;
            }
        }

        /* Large Desktops (1200px - 1399px) */
        @media (min-width: 1200px) and (max-width: 1399px) {
            .container {
                max-width: 1200px;
            }
            
            .upload-section,
            .results-section {
                padding: 25px;
            }
        }

        /* Tablets Landscape & Small Laptops (992px - 1199px) */
        @media (min-width: 992px) and (max-width: 1199px) {
            .header-content {
                padding: 8px 15px;
            }
            
            .header-logo {
                font-size: 1.4rem;
            }
            
            .container {
                padding: 20px 15px;
            }
            
            .upload-section,
            .results-section {
                padding: 20px;
                margin-bottom: 20px;
            }
            
            .btn {
                font-size: 0.8rem;
                padding: 7px 14px;
            }
        }

        /* Tablets Portrait (768px - 991px) */
        @media (min-width: 768px) and (max-width: 991px) {
            body {
                padding-top: 90px;
            }
            
            .header-content {
                flex-wrap: wrap;
                gap: 10px;
                padding: 12px 15px;
            }
            
            .header-logo {
                font-size: 1.5rem;
            }
            
            .container {
                padding: 15px 12px;
            }
            
            .upload-section,
            .results-section {
                padding: 18px;
                margin-bottom: 18px;
            }
            
            .btn {
                font-size: 0.8rem;
                padding: 6px 12px;
            }
            
            .sample-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
        }

        /* Mobile Landscape (576px - 767px) */
        @media (min-width: 576px) and (max-width: 767px) {
            body {
                padding-top: 100px;
            }
            
            .header-content {
                flex-direction: column;
                gap: 10px;
                padding: 12px 15px;
                align-items: center;
            }
            
            .header-logo {
                font-size: 1.3rem;
                text-align: center;
            }
            
            .header-title {
                display: block;
                text-align: center;
                font-size: 0.85rem;
            }
            
            .header-right {
                width: 100%;
                justify-content: center;
            }
            
            .container {
                padding: 15px 10px;
            }
            
            .upload-section,
            .results-section {
                padding: 16px;
                margin-bottom: 16px;
            }
            
            .btn {
                font-size: 0.75rem;
                padding: 5px 10px;
                gap: 4px;
            }
            
            .sample-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
        }

        /* Mobile Portrait (up to 575px) */
        @media (max-width: 575px) {
            body {
                padding-top: 110px;
            }
            
            .header-content {
                flex-direction: column;
                gap: 12px;
                padding: 15px 10px;
                align-items: center;
            }
            
            .header-logo {
                font-size: 1.2rem;
                text-align: center;
            }
            
            .header-logo i {
                font-size: 1.1rem;
            }
            
            .header-title {
                display: block;
                text-align: center;
                font-size: 0.8rem;
                margin-top: -5px;
            }
            
            /* Theme toggle responsive removed */
            
            .container {
                padding: 12px 8px;
            }
            
            .upload-section,
            .results-section {
                padding: 15px;
                margin-bottom: 15px;
                border-radius: 8px;
            }
            
            .section-header h2 {
                font-size: 1.3rem;
                text-align: center;
            }
            
            .section-header p {
                font-size: 0.85rem;
                text-align: center;
                margin-bottom: 15px;
            }
            
            .btn {
                font-size: 0.7rem;
                padding: 4px 8px;
                gap: 3px;
                min-height: 36px;
            }
            
            .btn i {
                font-size: 0.7rem;
            }
            
            .sample-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .sample-example,
            .sample-tips {
                padding: 12px;
            }
            
            .pre-formatted {
                padding: 10px;
                font-size: 0.8rem;
                overflow-x: auto;
            }

            /* Mobile styles สำหรับ Basic Information Table ขนาดเล็ก */
            .info-table {
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
            }

            .info-table td {
                padding: 8px 12px;
                font-size: 0.75rem;
            }

            .info-label {
                min-width: 120px;
                width: 45%;
                font-size: 0.7rem;
                letter-spacing: 0.5px;
                background: var(--bg-secondary);
            }

            .info-label i {
                margin-right: 6px;
                font-size: 0.8rem;
                width: 14px;
            }

            .info-value {
                padding-left: 12px;
                font-size: 0.75rem;
                background: var(--bg-card);
            }

            /* ปรับสีสำหรับ mobile - ใช้สีปกติ */
            .info-table tr:nth-child(n+4) .info-label {
                background: var(--bg-secondary);
                color: var(--text-primary);
            }

            .info-table tr:nth-child(n+4) .info-value {
                background: var(--bg-card);
                color: var(--text-primary);
            }
            
            .tips-list {
                font-size: 0.85rem;
            }
            
            .tips-list li {
                margin-bottom: 6px;
                padding-left: 18px;
            }
        }

        /* Touch device optimizations */
        @media (hover: none) and (pointer: coarse) {
            .btn:hover,
            .upload-section:hover {
                transform: none;
            }
            
            .btn:active,
            .upload-section:active {
                transform: scale(0.98);
            }
            
            /* Larger touch targets */
            .btn {
                min-height: 44px;
                padding: 8px 16px;
            }
        }

        /* Print styles */
        @media print {
            body {
                padding-top: 0;
            }
            
            .fixed-header {
                position: static;
                box-shadow: none;
                border-bottom: 2px solid #000;
                margin-bottom: 20px;
            }
            
            /* Theme toggle removed */
            
            .upload-section,
            .results-section {
                break-inside: avoid;
                box-shadow: none;
                border: 1px solid #ccc;
            }
        }

        /* Ultra-wide screens (1600px+) */
        @media (min-width: 1600px) {
            .container {
                max-width: 1600px;
                padding: 40px;
            }
            
            .upload-section,
            .results-section {
                padding: 35px;
            }
        }

        /* Force light theme always */
        html, html[data-theme="light"], html[data-theme="dark"] {
            color-scheme: light;
        }

        /* Hidden elements */
        .hidden {
            display: none;
        }

        .file-input {
            display: none;
        }

        /* Utility classes for inline styles */
        .dashboard-action-layout {
            margin-top: 20px;
            text-align: center;
            display: flex;
            justify-content: center;
            gap: 12px;
            position: relative;
            z-index: 10;
        }
        
        .dashboard-action-layout button {
            pointer-events: auto !important;
            z-index: 20 !important;
            position: relative !important;
        }

        .btn-min-width-180 {
            min-width: 180px;
            position: relative;
            z-index: 15;
        }

        .btn-min-width-120 {
            min-width: 120px;
            position: relative;
            z-index: 15;
        }

        .margin-top-10 {
            margin-top: 10px;
        }

        .margin-bottom-10 {
            margin-bottom: 10px;
        }

        .margin-bottom-15 {
            margin-bottom: 15px;
        }

        .text-small {
            font-size: 0.9em;
            color: #555;
        }



        .text-primary-color {
            color: var(--text-primary);
        }

        .monospace-table {
            font-family: monospace;
            font-size: 0.9em;
            border-collapse: collapse;
        }

        .table-header-cell {
            text-align: left;
            background: var(--bg-secondary);
            color: var(--text-primary);
            padding: 8px;
            border: 1px solid var(--border-color);
        }

        .table-header-center {
            text-align: center;
            background: var(--bg-secondary);
            color: var(--text-primary);
            min-width: 100px;
            padding: 8px;
            border: 1px solid var(--border-color);
        }

        .table-cell-bold {
            font-weight: bold;
            background: var(--bg-secondary);
            color: var(--text-primary);
            text-align: left;
            padding: 8px;
            border: 1px solid var(--border-color);
        }

        .error-header {
            background: var(--error-color);
            color: white;
        }

        .error-cell {
            color: var(--error-color);
            text-align: center;
            padding: 20px;
        }

        .significant-row {
            background-color: #fff3cd;
        }

        .cell-significant {
            background: #dc3545;
            color: white;
            font-weight: bold;
            text-align: center;
            padding: 8px;
            border: 1px solid var(--border-color);
        }

        .cell-normal {
            background: var(--bg-card);
            color: var(--text-primary);
            text-align: center;
            padding: 8px;
            border: 1px solid var(--border-color);
        }

        .cell-error {
            background: var(--error-color);
            color: white;
            text-align: center;
            padding: 8px;
            border: 1px solid var(--border-color);
        }

        /* Simple Footer Styles */
        .simple-footer {
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            margin-top: 2rem;
            padding: 1rem 0;
            text-align: center;
        }

        .footer-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        .simple-footer p {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin: 0;
        }



        /* Footer Responsive Design */
        @media (max-width: 480px) {
            .simple-footer {
                margin-top: 1.5rem;
                padding: 0.75rem 0;
            }
            
            .simple-footer p {
                font-size: 0.8rem;
            }
        }

        /* Results Panel Styles - Dashboard Style */
        .results-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: var(--bg-card);
            border-left: 1px solid var(--border-color);
            z-index: 1500;
            transition: right 0.3s ease;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
        }

        .results-panel.open {
            right: 0;
        }

        .results-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-primary);
        }

        .results-panel-header h3 {
            margin: 0;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.1rem;
        }

        .results-panel-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .results-panel-close:hover {
            background: rgba(var(--primary-color-rgb), 0.1);
            color: var(--primary-color);
        }

        .results-panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .results-message {
            text-align: center;
            color: var(--text-secondary);
            padding: 40px 20px;
        }

        .results-message i {
            font-size: 2rem;
            margin-bottom: 15px;
            color: var(--primary-color);
        }

        .results-links {
            display: none;
        }

        .results-links.show {
            display: block;
        }

        .results-links h4 {
            margin-bottom: 15px;
            color: var(--text-color);
            font-size: 1rem;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 8px;
        }

        .results-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .results-item {
            margin-bottom: 8px;
        }

        .results-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            text-decoration: none;
            color: var(--text-color);
            transition: all 0.3s ease;
        }

        .results-link:hover {
            background: rgba(var(--primary-color-rgb), 0.1);
            border-color: var(--primary-color);
            transform: translateX(4px);
        }

        .results-link i {
            color: var(--primary-color);
            width: 16px;
            text-align: center;
        }

        .results-panel-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            z-index: 1400;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            -webkit-backdrop-filter: blur(2px);
            backdrop-filter: blur(2px);
        }

        .results-panel-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        /* Responsive Results Panel */
        @media (max-width: 768px) {
            .results-panel {
                width: 100%;
                right: -100%;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h3>
                <i class="fas fa-chart-line"></i>
                Menu
            </h3>
        </div>
        <div class="sidebar-content">
            <nav>
                <ul class="sidebar-menu">
                    <li class="sidebar-menu-item">
                        <button class="sidebar-menu-link active" id="homeMenu">
                            <i class="fas fa-home sidebar-menu-icon"></i>
                            <span>HOME</span>
                        </button>
                    </li>
                    <li class="sidebar-menu-item">
                        <button class="sidebar-menu-link" id="dashboardMenu">
                            <i class="fas fa-chart-pie sidebar-menu-icon"></i>
                            <span>Dashboard</span>
                        </button>
                    </li>
                    <li class="sidebar-menu-item">
                        <button class="sidebar-menu-link" id="exportMenu">
                            <i class="fas fa-download sidebar-menu-icon"></i>
                            <span>Export</span>
                        </button>
                    </li>
                    <li class="sidebar-menu-item">
                        <button class="sidebar-menu-link" id="resultsMenu">
                            <i class="fas fa-chart-bar sidebar-menu-icon"></i>
                            <span>Results</span>
                        </button>
                    </li>
                </ul>
            </nav>
        </div>
    </aside>

    <!-- Fixed Header -->
    <div class="fixed-header">
        <div class="header-content">
            <div class="header-left">
                <!-- Sidebar Toggle Button inside header -->
                <button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle Sidebar">
                    <i class="fas fa-bars"></i>
                </button>
                <a href="#" class="header-logo">
                    <i class="fas fa-chart-line"></i>
                    Statistics Analysis
                </a>
            </div>
            <div class="header-right">

            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="main-content" id="mainContent">
        <div class="container">
            <div class="header">
                <h1><i class="fas fa-chart-line"></i> Statistics Analysis</h1>
            </div>

        <div class="card">
            <!-- Input Method Tabs -->
            <div class="input-tabs">
                <button class="tab-button active" onclick="switchInputMethod('csv')" id="csvTabBtn">
                    <i class="fas fa-file-csv"></i> CSV Upload
                </button>
                <button class="tab-button" onclick="switchInputMethod('text')" id="textTabBtn">
                    <i class="fas fa-edit"></i> Copy & Paste
                </button>
            </div>

            <!-- CSV Upload Tab -->
            <div id="csvInputTab" class="input-tab active">
                <div class="upload-area" id="uploadArea">
                    <i class="fas fa-cloud-upload-alt upload-icon"></i>
                    <h3 class="upload-title">Upload Dataset</h3>
                    <p class="upload-subtitle">
                        Drop CSV file here or click to browse<br>
                        <small>Format: Column A (LOT names), Column B (Numeric data)</small>
                    </p>
                    <input type="file" id="fileInput" class="file-input" accept=".csv">
                    <button class="btn" id="chooseFileBtn">
                        <i class="fas fa-folder-open"></i> Choose File
                    </button>
                    <p id="fileNameDisplay"></p>
                </div>
            </div>

            <!-- Text Input Tab -->
            <div id="textInputTab" class="input-tab">
                <div class="text-input-area">
                    <textarea 
                        id="dataTextArea" 
                        placeholder="Paste your data here, example:
LOT1 10.2
LOT1 11.5
LOT2 12.1
LOT2 11.8
LOT3 9.8
LOT3 9.5
LOT4 13.2
LOT4 12.9

Each line: LOT_name numeric_value (space-separated)"
                        rows="12">
                    </textarea>
                    
                    <div id="textDataPreview" class="data-preview hidden">
                        <h4><i class="fas fa-eye"></i> Data Preview:</h4>
                        <div id="previewTable"></div>
                        <div id="previewStats"></div>
                    </div>
                </div>
            </div>

            <div class="sample-section">
                <div class="sample-title">
                    <i class="fas fa-lightbulb"></i>
                    Sample CSV Format
                </div>
                <div class="sample-grid">
                    <div class="sample-example">
                        <h5><i class="fas fa-file-csv"></i> Your CSV should look like this:</h5>
                        <div class="pre-formatted">LOT1,10.2
LOT1,11.5
LOT2,12.1
LOT2,11.8
LOT3,9.8
LOT3,9.5</div>
                    </div>
                    <div class="sample-tips">
                        <h5><i class="fas fa-tips"></i> Quick Tips:</h5>
                        <ul class="tips-list">
                            <li>Column A: LOT names (text)</li>
                            <li>Column B: Numeric data</li>
                            <li>No headers needed</li>
                            <li>At least 2 groups required</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Table Names Section -->
            <div class="table-names-section-compact">
                <div class="compact-suffix-input">
                    <label for="tableNameSuffix"><i class="fas fa-tag"></i> Add Table Suffix:</label>
                    <input type="text" id="tableNameSuffix" class="suffix-input-compact" placeholder="">
                </div>
            </div>

            <div class="input-grid">
                <div class="input-group">
                    <label for="lsl"><i class="fas fa-arrow-down"></i> Lower Spec Limit (LSL)</label>
                    <input type="number" id="lsl" placeholder="e.g., 9.0" step="any">
                </div>
                <div class="input-group">
                    <label for="usl"><i class="fas fa-arrow-up"></i> Upper Spec Limit (USL)</label>
                    <input type="number" id="usl" placeholder="e.g., 13.0" step="any">
                </div>
            </div>

            <button id="analyzeBtn" class="btn btn-accent">
                <i class="fas fa-rocket"></i> Perform Analysis
            </button>
        </div>

        <div id="resultsSection" class="results-section">
            <div id="loadingDiv" class="loading">
                <div class="spinner"></div>
                <h3>Processing Statistical Analysis...</h3>
                <p class="loading-text">Please wait while we analyze your data</p>
            </div>

            <div id="resultsContent" class="hidden">

            </div>
        </div>
    </div>

    <script>
        // Error handling wrapper
        window.addEventListener('error', function(e) {
            console.error('❌ Global JavaScript Error:', e.error);
            console.error('Error details:', {
                message: e.message,
                filename: e.filename,
                lineno: e.lineno,
                colno: e.colno,
                stack: e.error?.stack
            });
        });

        // Promise rejection handler
        window.addEventListener('unhandledrejection', function(e) {
            console.error('❌ Unhandled Promise Rejection:', e.reason);
        });

        console.log('🔥 JavaScript loaded successfully');
        console.log('🔍 Current location:', window.location.href);

        // Global variables
        let csvFile = null;
        let csvFileContent = null;
        let resizeTimeout;
        let currentDeviceType = 'desktop';
        
        // DOM element references - will be initialized after DOM loads
        let uploadArea, fileInput, analyzeBtn, fileNameDisplay, resultsSection, loadingDiv, resultsContent;
        
        console.log('🌍 Global variables initialized');

        // Dynamic Device Detection and Responsive Adjustments
        function detectDeviceTypeAndApplyStyles() {
            const width = window.innerWidth;
            const height = window.innerHeight;
            const orientation = width > height ? 'landscape' : 'portrait';
            
            let deviceType = 'desktop';
            let deviceClass = '';
            
            if (width <= 575) {
                deviceType = 'mobile-portrait';
                deviceClass = 'mobile-xs';
            } else if (width <= 767) {
                deviceType = 'mobile-landscape';
                deviceClass = 'mobile-sm';
            } else if (width <= 991) {
                deviceType = 'tablet-portrait';
                deviceClass = 'tablet-md';
            } else if (width <= 1199) {
                deviceType = 'tablet-landscape';
                deviceClass = 'tablet-lg';
            } else if (width <= 1399) {
                deviceType = 'desktop';
                deviceClass = 'desktop-xl';
            } else {
                deviceType = 'desktop-large';
                deviceClass = 'desktop-xxl';
            }
            
            // Apply device-specific classes to body
            document.body.className = document.body.className.replace(/\b(mobile-xs|mobile-sm|tablet-md|tablet-lg|desktop-xl|desktop-xxl)\b/g, '');
            document.body.classList.add(deviceClass);
            
            // Set CSS custom properties for dynamic sizing
            const root = document.documentElement;
            root.style.setProperty('--screen-width', width + 'px');
            root.style.setProperty('--screen-height', height + 'px');
            root.style.setProperty('--device-type', deviceType);
            root.setAttribute('data-device', deviceType);
            root.setAttribute('data-orientation', orientation);
            
            // Dynamic font scaling
            if (width <= 575) {
                root.style.setProperty('--base-font-size', '14px');
                root.style.setProperty('--heading-scale', '0.8');
            } else if (width <= 767) {
                root.style.setProperty('--base-font-size', '15px');
                root.style.setProperty('--heading-scale', '0.9');
            } else if (width <= 991) {
                root.style.setProperty('--base-font-size', '16px');
                root.style.setProperty('--heading-scale', '1.0');
            } else {
                root.style.setProperty('--base-font-size', '16px');
                root.style.setProperty('--heading-scale', '1.0');
            }
            
            // Trigger layout recalculation if device type changed
            if (currentDeviceType !== deviceType) {
                currentDeviceType = deviceType;
                adjustLayoutForDevice();
                console.log(`📱 Device changed to: ${deviceType} (${width}x${height})`);
            }
            
            return { deviceType, orientation, width, height };
        }

        // Adjust specific elements based on device
        function adjustLayoutForDevice() {
            const deviceInfo = detectDeviceTypeAndApplyStyles();
            
            // Adjust button sizes
            const buttons = document.querySelectorAll('.btn');
            buttons.forEach(btn => {
                if (deviceInfo.width <= 575) {
                    btn.style.fontSize = '0.75rem';
                    btn.style.padding = '8px 12px';
                } else if (deviceInfo.width <= 767) {
                    btn.style.fontSize = '0.8rem';
                    btn.style.padding = '9px 14px';
                } else {
                    btn.style.fontSize = '';
                    btn.style.padding = '';
                }
            });
            
            // Adjust container padding
            const container = document.querySelector('.container');
            if (container) {
                if (deviceInfo.width <= 575) {
                    container.style.padding = '10px 8px';
                } else if (deviceInfo.width <= 767) {
                    container.style.padding = '15px 10px';
                } else {
                    container.style.padding = '';
                }
            }
            
            // Adjust cards
            const cards = document.querySelectorAll('.card, .result-card');
            cards.forEach(card => {
                if (deviceInfo.width <= 575) {
                    card.style.padding = '15px';
                    card.style.marginBottom = '12px';
                } else if (deviceInfo.width <= 767) {
                    card.style.padding = '18px';
                    card.style.marginBottom = '15px';
                } else {
                    card.style.padding = '';
                    card.style.marginBottom = '';
                }
            });
            
            // Adjust tables for mobile
            const tables = document.querySelectorAll('table');
            tables.forEach(table => {
                if (deviceInfo.width <= 767) {
                    table.style.fontSize = '0.75rem';
                    const cells = table.querySelectorAll('th, td');
                    cells.forEach(cell => {
                        cell.style.padding = '6px 8px';
                    });
                } else {
                    table.style.fontSize = '';
                    const cells = table.querySelectorAll('th, td');
                    cells.forEach(cell => {
                        cell.style.padding = '';
                    });
                }
            });
        }

        // Debounced resize handler
        function handleResize() {
            if (resizeTimeout) clearTimeout(resizeTimeout);
            
            resizeTimeout = setTimeout(() => {
                const deviceInfo = detectDeviceTypeAndApplyStyles();
                
                // Show resize notification for debugging - DISABLED
                // console.log(`🔄 Resized to: ${deviceInfo.width}x${deviceInfo.height} (${deviceInfo.deviceType})`);
                
                // Visual feedback for responsive changes - DISABLED
                // if (typeof showNotification === 'function') {
                //     showNotification(`📱 Layout adjusted for ${deviceInfo.deviceType.replace('-', ' ')} (${deviceInfo.width}px wide)`, 'info');
                // }
                
                // Add visual indicator to body
                document.body.setAttribute('data-responsive-info', `${deviceInfo.deviceType} ${deviceInfo.width}x${deviceInfo.height}`);
            }, 150);
        }



        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            

            
            // Initialize DOM element references
            uploadArea = document.getElementById('uploadArea');
            fileInput = document.getElementById('fileInput');
            analyzeBtn = document.getElementById('analyzeBtn');
            fileNameDisplay = document.getElementById('fileNameDisplay');
            resultsSection = document.getElementById('resultsSection');
            loadingDiv = document.getElementById('loadingDiv');
            resultsContent = document.getElementById('resultsContent');
            
            // Text input elements
            const dataTextArea = document.getElementById('dataTextArea');
            const processTextBtn = document.getElementById('processTextBtn');
            
            // Check if critical elements exist
            const elementsToCheck = [
                {name: 'uploadArea', element: uploadArea},
                {name: 'fileInput', element: fileInput},
                {name: 'analyzeBtn', element: analyzeBtn},
                {name: 'resultsSection', element: resultsSection},
                {name: 'loadingDiv', element: loadingDiv},
                {name: 'resultsContent', element: resultsContent},
                {name: 'fileNameDisplay', element: fileNameDisplay},
                {name: 'dataTextArea', element: dataTextArea},
                {name: 'processTextBtn', element: processTextBtn}
            ];
            
            for (const {name, element} of elementsToCheck) {
                console.log(`🔍 Element ${name}:`, element ? '✅ Found' : '❌ Missing');
            }
            
            // Add text area input listener
            if (dataTextArea) {
                dataTextArea.addEventListener('input', function() {
                    const hasText = this.value.trim().length > 0;
                    if (processTextBtn) {
                        processTextBtn.disabled = !hasText;
                    }
                    // Clear previous preview when text changes
                    hideTextPreview();
                    processedData = null;
                    resetAnalysisButton();
                });
            }
            
            // Check if performAnalysis function exists
            console.log('🔍 performAnalysis function:', typeof performAnalysis);
            
            // Initialize event listeners after elements are found
            if (uploadArea && fileInput) {
                initializeEventListeners();
            } else {
                console.error('❌ Critical elements missing - cannot initialize event listeners');
            }
            
            detectDeviceTypeAndApplyStyles();
            // addResponsiveDebugInfo(); // DISABLED - No debug info display
            console.log('🚀 Responsive system initialized');
            
            // Show welcome message with device info - DISABLED
            // setTimeout(() => {
            //     const deviceInfo = detectDeviceTypeAndApplyStyles();
            //     if (typeof showNotification === 'function') {
            //         showNotification(`🎉 Welcome! Optimized for ${deviceInfo.deviceType.replace('-', ' ')} (${deviceInfo.width}px)`, 'success');
            //     }
            // }, 1000);
        });

        // Handle resize and orientation changes
        window.addEventListener('resize', handleResize);
        window.addEventListener('orientationchange', function() {
            setTimeout(() => {
                detectDeviceTypeAndApplyStyles();
                // console.log('📱 Orientation changed'); // DISABLED
            }, 100);
        });

        // Original variables and code continue here...

        // ฟังก์ชันสำหรับ Input Method Switching และ Text Processing
        let currentInputMethod = 'csv';
        let processedData = null;

        function switchInputMethod(method) {
            console.log(`🔄 Switching input method to: ${method}`);
            
            // Update tab buttons
            document.getElementById('csvTabBtn').classList.toggle('active', method === 'csv');
            document.getElementById('textTabBtn').classList.toggle('active', method === 'text');
            
            // Update tab content
            document.getElementById('csvInputTab').classList.toggle('active', method === 'csv');
            document.getElementById('textInputTab').classList.toggle('active', method === 'text');
            
            currentInputMethod = method;
            
            // Reset any previous data
            processedData = null;
            resetAnalysisButton();
        }

        function clearTextInput() {
            document.getElementById('dataTextArea').value = '';
            hideTextPreview();
            processedData = null;
            resetAnalysisButton();
        }

        function pasteExample() {
            const exampleData = `LOT1 10.2
LOT1 11.5
LOT1 10.8
LOT2 12.1
LOT2 11.8
LOT2 12.3
LOT3 9.8
LOT3 9.5
LOT3 10.1
LOT4 13.2
LOT4 12.9
LOT4 13.5`;
            
            document.getElementById('dataTextArea').value = exampleData;
            processTextData();
        }

        async function processTextDataSilently() {
            const textArea = document.getElementById('dataTextArea');
            const text = textArea.value.trim();
            
            console.log('🔍 processTextDataSilently called');
            console.log('🔍 Text area content:', text.substring(0, 100) + '...');
            
            if (!text) {
                throw new Error('No text data found');
            }
            
            try {
                // Always use space-separated format
                const separator = /\s+/; // Use space/whitespace separator
                
                const lines = text.split('\n').filter(line => line.trim());
                const data = [];
                const groups = {};
                
                console.log(`🔍 Processing ${lines.length} lines`);
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    
                    const parts = line.split(separator);
                    if (parts.length !== 2) {
                        throw new Error(`Line ${i + 1}: Expected 2 columns, got ${parts.length}. Line: "${line}"`);
                    }
                    
                    const lotName = parts[0].trim();
                    const value = parseFloat(parts[1].trim());
                    
                    if (!lotName) {
                        throw new Error(`Line ${i + 1}: LOT name cannot be empty`);
                    }
                    
                    if (isNaN(value)) {
                        throw new Error(`Line ${i + 1}: "${parts[1].trim()}" is not a valid number`);
                    }
                    
                    data.push({ LOT: lotName, DATA: value });
                    
                    if (!groups[lotName]) {
                        groups[lotName] = [];
                    }
                    groups[lotName].push(value);
                }
                
                // Validation
                if (data.length === 0) {
                    throw new Error('No valid data found');
                }
                
                const uniqueGroups = Object.keys(groups);
                if (uniqueGroups.length < 2) {
                    throw new Error(`At least 2 groups required, found ${uniqueGroups.length}`);
                }
                
                // Check minimum data per group
                for (const group of uniqueGroups) {
                    if (groups[group].length < 1) {
                        throw new Error(`Group "${group}" has no data`);
                    }
                }
                
                processedData = data;
                console.log(`✅ Silently processed ${data.length} rows with ${uniqueGroups.length} groups`);
                console.log('🔍 processedData set to:', processedData ? 'exists' : 'null');
                
            } catch (error) {
                console.error('❌ Silent text processing error:', error);
                throw error;
            }
        }

        function processTextData() {
            const textArea = document.getElementById('dataTextArea');
            const processBtn = document.getElementById('processTextBtn');
            const text = textArea.value.trim();
            
            if (!text) {
                showNotification('Please enter some data first', 'error');
                return;
            }
            
            // Disable button and show processing state
            processBtn.disabled = true;
            processBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            
            try {
                // Always use space-separated format
                const separator = /\s+/; // Use space/whitespace separator
                
                const lines = text.split('\n').filter(line => line.trim());
                const data = [];
                const groups = {};
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    
                    const parts = line.split(separator);
                    if (parts.length !== 2) {
                        throw new Error(`Line ${i + 1}: Expected 2 columns, got ${parts.length}. Line: "${line}"`);
                    }
                    
                    const lotName = parts[0].trim();
                    const value = parseFloat(parts[1].trim());
                    
                    if (!lotName) {
                        throw new Error(`Line ${i + 1}: LOT name cannot be empty`);
                    }
                    
                    if (isNaN(value)) {
                        throw new Error(`Line ${i + 1}: "${parts[1].trim()}" is not a valid number`);
                    }
                    
                    data.push({ LOT: lotName, DATA: value });
                    
                    if (!groups[lotName]) {
                        groups[lotName] = [];
                    }
                    groups[lotName].push(value);
                }
                
                // Validation
                if (data.length === 0) {
                    throw new Error('No valid data found');
                }
                
                const uniqueGroups = Object.keys(groups);
                if (uniqueGroups.length < 2) {
                    throw new Error(`At least 2 groups required, found ${uniqueGroups.length}`);
                }
                
                // Check minimum data per group
                for (const group of uniqueGroups) {
                    if (groups[group].length < 1) {
                        throw new Error(`Group "${group}" has no data`);
                    }
                }
                
                processedData = data;
                showTextPreview(data, groups);
                enableAnalysisButton();
                showNotification(`✅ Successfully processed ${data.length} rows with ${uniqueGroups.length} groups`, 'success');
                
                // Update button to show analysis phase
                processBtn.innerHTML = '<i class="fas fa-chart-line"></i> Analyzing...';
                
                // Auto-perform analysis after successful data processing
                console.log('🚀 Auto-starting analysis after data processing...');
                setTimeout(() => {
                    performAnalysis().finally(() => {
                        // Reset button after analysis completes
                        processBtn.disabled = false;
                        processBtn.innerHTML = '<i class="fas fa-play"></i> Process & Analyze Data';
                    });
                }, 500); // Small delay to allow UI updates
                
            } catch (error) {
                console.error('Text processing error:', error);
                showNotification(`❌ Error processing text: ${error.message}`, 'error');
                hideTextPreview();
                processedData = null;
                resetAnalysisButton();
                
                // Reset button on error
                processBtn.disabled = false;
                processBtn.innerHTML = '<i class="fas fa-play"></i> Process & Analyze Data';
            }
        }

        function showTextPreview(data, groups) {
            const preview = document.getElementById('textDataPreview');
            const table = document.getElementById('previewTable');
            const stats = document.getElementById('previewStats');
            
            // Create preview table (first 10 rows)
            const previewData = data.slice(0, 10);
            let tableHTML = `
                <div class="preview-table">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>LOT</th>
                                <th>DATA</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            previewData.forEach(row => {
                tableHTML += `<tr><td>${row.LOT}</td><td>${row.DATA}</td></tr>`;
            });
            
            if (data.length > 10) {
                tableHTML += `<tr><td colspan="2" style="text-align: center; font-style: italic;">... and ${data.length - 10} more rows</td></tr>`;
            }
            
            tableHTML += '</tbody></table></div>';
            table.innerHTML = tableHTML;
            
            // Create stats
            const uniqueGroups = Object.keys(groups);
            let statsHTML = '<div class="preview-stats">';
            
            statsHTML += `
                <div class="stat-item">
                    <div class="stat-label">Total Rows</div>
                    <div class="stat-value">${data.length}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Groups</div>
                    <div class="stat-value">${uniqueGroups.length}</div>
                </div>
            `;
            
            // Group details
            uniqueGroups.forEach(group => {
                const count = groups[group].length;
                const mean = (groups[group].reduce((a, b) => a + b, 0) / count).toFixed(2);
                statsHTML += `
                    <div class="stat-item">
                        <div class="stat-label">${group}</div>
                        <div class="stat-value">${count} values (avg: ${mean})</div>
                    </div>
                `;
            });
            
            statsHTML += '</div>';
            stats.innerHTML = statsHTML;
            
            preview.classList.remove('hidden');
        }

        function hideTextPreview() {
            const preview = document.getElementById('textDataPreview');
            if (preview) {
                preview.classList.add('hidden');
            }
        }

        function enableAnalysisButton() {
            const analyzeBtn = document.getElementById('analyzeBtn');
            if (analyzeBtn) {
                analyzeBtn.disabled = false;
                analyzeBtn.innerHTML = '<i class="fas fa-chart-line"></i> Analyze Data';
            }
        }

        function resetAnalysisButton() {
            const analyzeBtn = document.getElementById('analyzeBtn');
            if (analyzeBtn) {
                analyzeBtn.disabled = false; // Enable the button
                analyzeBtn.innerHTML = '<i class="fas fa-rocket"></i> Perform Analysis';
            }
        }

        // Function to initialize event listeners after DOM is ready
        function initializeEventListeners() {
            console.log('🔗 Initializing event listeners...');
            
            if (!uploadArea || !fileInput) {
                console.error('❌ Critical elements not found for event listeners');
                return;
            }

            // Get the choose file button
            const chooseFileBtn = document.getElementById('chooseFileBtn');

            // Drag and drop events for upload area
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            });

            // Click events - separate for upload area and choose file button
            uploadArea.addEventListener('click', (e) => {
                // Only trigger if not clicking on the choose file button
                if (e.target !== chooseFileBtn && !chooseFileBtn.contains(e.target)) {
                    console.log('📍 Upload area clicked (not button)');
                    fileInput.click();
                }
            });

            // Choose file button event
            if (chooseFileBtn) {
                chooseFileBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('📍 Choose file button clicked');
                    fileInput.click();
                });
            }

            // File input change event
            fileInput.addEventListener('change', (e) => {
                console.log('📁 File input changed');
                if (e.target.files.length > 0) {
                    handleFile(e.target.files[0]);
                } else {
                    console.log('⚠️ No files selected');
                }
            });
            
            // Add event listeners for buttons
            const analyzeBtn = document.getElementById('analyzeBtn');
            
            if (analyzeBtn) {
                analyzeBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('🚀 Analyze button clicked');
                    performAnalysis();
                });
            }
            
            console.log('✅ Event listeners initialized successfully');
        }

        function handleFile(file) {
            console.log('📁 handleFile called with:', file?.name);
            console.log('📊 handleFile call stack:', new Error().stack);
            
            // Prevent double calls
            if (handleFile.isProcessing) {
                console.log('⚠️ handleFile already processing, skipping duplicate call');
                return;
            }
            
            handleFile.isProcessing = true;
            
            if (!file.name.toLowerCase().endsWith('.csv')) {
                showError('Please select a CSV file.');
                if (analyzeBtn) analyzeBtn.disabled = true;
                if (fileNameDisplay) fileNameDisplay.textContent = '';
                csvFile = null;
                csvFileContent = null;
                handleFile.isProcessing = false;
                return;
            }
            csvFile = file;
            if (fileNameDisplay) fileNameDisplay.textContent = `Selected: ${file.name}`;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                csvFileContent = e.target.result;
                if (analyzeBtn) analyzeBtn.disabled = false;
                showSuccess(`File loaded successfully: ${file.name}`);
                console.log('✅ CSV file loaded, analyze button enabled');
                handleFile.isProcessing = false;
            };
            reader.onerror = (e) => {
                showError(`Error reading file: ${e.target.error.name}`);
                if (analyzeBtn) analyzeBtn.disabled = true;
                if (fileNameDisplay) fileNameDisplay.textContent = '';
                csvFile = null;
                csvFileContent = null;
                handleFile.isProcessing = false;
            };
            reader.readAsText(file);
        }

        async function performAnalysis() {
            console.log('🚀 performAnalysis called');
            
            // ตรวจสอบ tab ที่กำลัง active อยู่
            const csvTab = document.getElementById('csvInputTab');
            const textTab = document.getElementById('textInputTab');
            const csvTabActive = csvTab && csvTab.classList.contains('active');
            const textTabActive = textTab && textTab.classList.contains('active');
            
            // อัปเดต currentInputMethod ตาม tab ที่ active
            if (csvTabActive) {
                currentInputMethod = 'csv';
            } else if (textTabActive) {
                currentInputMethod = 'text';
            }
            
            console.log('🔍 Current input method:', currentInputMethod);
            console.log('🔍 CSV tab active:', csvTabActive);
            console.log('🔍 Text tab active:', textTabActive);
            console.log('🔍 Current csvFileContent:', csvFileContent ? 'exists' : 'null');
            console.log('🔍 Current processedData:', processedData ? 'exists' : 'null');
            
            let dataToAnalyze = null;
            
            // ถ้าอยู่ใน text tab ให้ลองประมวลผลข้อมูลจาก textarea ก่อน (ไม่ว่าจะมี processedData หรือไม่)
            if (currentInputMethod === 'text') {
                const textArea = document.getElementById('dataTextArea');
                if (textArea && textArea.value.trim()) {
                    console.log('🔄 Auto-processing text data before analysis...');
                    try {
                        // เรียกใช้ processTextData โดยไม่แสดง UI loading
                        await processTextDataSilently();
                        console.log('✅ Text data auto-processed successfully');
                    } catch (error) {
                        console.error('❌ Auto-processing failed:', error);
                        showError(`📝 Error processing your data: ${error.message}\n\nPlease check your data format:\n• Each line: LOT_name numeric_value\n• Use space separation: LOT1 10.2\n• At least 2 groups required`);
                        return;
                    }
                }
            }
            
            // ตรวจสอบข้อมูลตามวิธีป้อนข้อมูล
            if (currentInputMethod === 'csv') {
                if (!csvFileContent) {
                    console.error('❌ No CSV file content available');
                    showError('📁 Please upload a CSV file first.\n\n1. Click "Choose File" or drag & drop your CSV file\n2. Wait for the file to be processed\n3. Then click "Perform Analysis"');
                    return;
                }
                dataToAnalyze = csvFileContent;
            } else if (currentInputMethod === 'text') {
                if (!processedData) {
                    console.error('❌ No processed text data available after auto-processing');
                    showError('📝 Please paste your data in the text area above.\n\nExpected format:\nLOT1 10.2\nLOT1 11.5\nLOT2 12.1\nLOT2 11.8\n\nEach line: LOT_name numeric_value (space-separated)');
                    return;
                }
                dataToAnalyze = processedData;
            } else {
                console.error('❌ Unknown input method:', currentInputMethod);
                showError('❓ Please choose your data input method:\n\n• Upload a CSV file in the CSV Upload tab, OR\n• Use Copy & Paste tab to input your data manually');
                return;
            }

            // Clear previous results and messages
            resultsContent.innerHTML = '';
            clearMessages();
            
            console.log('📱 Setting up UI for loading...');
            
            // Show results section and loading
            resultsSection.style.display = 'block';
            resultsSection.classList.add('visible');
            loadingDiv.style.display = 'block';
            resultsContent.style.display = 'none';

            const lslInput = document.getElementById('lsl').value;
            const uslInput = document.getElementById('usl').value;
            const lsl = lslInput ? parseFloat(lslInput) : null;
            const usl = uslInput ? parseFloat(uslInput) : null;

            console.log('📊 Input values:', { 
                lsl, 
                usl, 
                dataLength: dataToAnalyze.length,
                inputMethod: currentInputMethod
            });

            if (lslInput && isNaN(lsl)) {
                showError('LSL must be a valid number.');
                hideLoading();
                return;
            }
            if (uslInput && isNaN(usl)) {
                showError('USL must be a valid number.');
                hideLoading();
                return;
            }

            try {
                console.log('🔄 Starting analysis...');
                
                // Convert data to proper format for backend
                let csvDataForBackend;
                if (currentInputMethod === 'text') {
                    // Convert array of objects to CSV string format
                    console.log('🔄 Converting text data to CSV format...');
                    csvDataForBackend = dataToAnalyze.map(row => `${row.LOT},${row.DATA}`).join('\n');
                    console.log('📝 Converted CSV data sample:', csvDataForBackend.substring(0, 100) + '...');
                    
                    // Validate conversion
                    if (!csvDataForBackend || csvDataForBackend.length === 0) {
                        throw new Error('Failed to convert text data to CSV format');
                    }
                } else {
                    // CSV data is already in string format
                    csvDataForBackend = dataToAnalyze;
                }
                
                const requestData = {
                    csv_data: csvDataForBackend,
                    LSL: lsl,
                    USL: usl
                };
                
                console.log('📝 Request data prepared:');
                console.log('   - Input method:', currentInputMethod);
                console.log('   - Data type:', typeof csvDataForBackend);
                console.log('   - Data rows:', csvDataForBackend.split('\n').length);
                console.log('   - Sample data:', csvDataForBackend.substring(0, 200) + '...');
                
                // Use relative URL for production compatibility
                const url = '/analyze_anova';
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                console.log(`✅ Response received:`, response.status);

                console.log('📊 Response status:', response.status);
                console.log('📋 Response headers:', Object.fromEntries(response.headers.entries()));

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('❌ Error response:', errorText);
                    
                    let errorMessage = `Server error: ${response.status}`;
                    try {
                        const errorJson = JSON.parse(errorText);
                        errorMessage = errorJson.error || errorMessage;
                    } catch (e) {
                        errorMessage = errorText.substring(0, 200) + '...';
                    }
                    
                    throw new Error(errorMessage);
                }

                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const responseText = await response.text();
                    console.error('❌ Non-JSON response:', responseText);
                    throw new Error('Server returned non-JSON response. Check server logs.');
                }

                console.log('🎯 Parsing JSON response...');
                const results = await response.json();
                console.log('✅ Successfully received results:', Object.keys(results));
                
                displayResults(results);

            } catch (error) {
                console.error('💥 Analysis error:', error);
                hideLoading();
                showError(`Analysis failed: ${error.message}`);
            }
        }

        function hideLoading() {
            console.log('🔄 Hiding loading UI');
            loadingDiv.style.display = 'none';
            resultsContent.style.display = 'none';
        }

        function clearMessages() {
            const messageDiv = document.getElementById('messageArea');
            if (messageDiv) {
                messageDiv.remove();
            }
        }

        // Helper function to safely format numbers
        function safeToFixed(value, decimals = 4) {
            if (value == null || isNaN(value)) {
                return 'N/A';
            }
            return Number(value).toFixed(decimals);
        }

        function displayResults(results) {
            console.log('🎯 displayResults called with keys:', Object.keys(results));
            
            const content = document.getElementById('resultsContent');
            content.innerHTML = '';

            // อ่าน suffix ที่จะเพิ่มต่อท้ายทุกตาราง
            const suffix = document.getElementById('tableNameSuffix')?.value.trim() || '';
            const addSuffix = (originalName) => suffix ? `${originalName} (${suffix})` : originalName;

            const tableNames = {
                onewayAnalysis: addSuffix('Oneway Analysis of Data By LOT'),
                anova: addSuffix('Analysis of Variance'),
                means: addSuffix('Means for Oneway ANOVA'),
                stdDeviations: addSuffix('Means and Std Deviations'),
                confidenceQuantile: addSuffix('Confidence Quantile'),
                hsdMatrix: addSuffix('HSD Threshold Matrix'),
                connectingLetters: addSuffix('Connecting Letters Report'),
                orderedDifferences: addSuffix('Ordered Differences Report'),
                varianceTests: addSuffix('Tests that the Variances are Equal'),
                welchTest: addSuffix('Welch\'s Test'),
                tukeyHsd: addSuffix('TUKEY-KRAMER HSD POST-HOC ANALYSIS'),
                varianceChart: addSuffix('Variance Chart'),
                meanAbsoluteDeviations: addSuffix('MEAN ABSOLUTE DEVIATIONS')
            };
            
            console.log('🏷️ Table names:', tableNames);

            try {
                // 1. Basic Information
                console.log('📊 Creating basic info card...');
                const basicCard = createCard('<i class="fas fa-info-circle"></i> Basic Information', `
                    <div class="basic-info-table">
                        <table class="info-table">
                            <tbody>
                                <tr>
                                    <td class="info-label"><i class="fas fa-database"></i> Total Data Points</td>
                                    <td class="info-value">${results.basicInfo?.totalPoints || 'N/A'}</td>
                                </tr>
                                <tr>
                                    <td class="info-label"><i class="fas fa-layer-group"></i> Number of LOTs</td>
                                    <td class="info-value">${results.basicInfo?.numLots || 'N/A'}</td>
                                </tr>
                                <tr>
                                    <td class="info-label"><i class="fas fa-tags"></i> LOTs Present</td>
                                    <td class="info-value">${results.basicInfo?.lotNames?.join(', ') || 'N/A'}</td>
                                </tr>
                                ${results.basicInfo?.groupCounts ? Object.keys(results.basicInfo.groupCounts).map(lot => `
                                <tr>
                                    <td class="info-label"><i class="fas fa-chart-bar"></i> ${lot}</td>
                                    <td class="info-value">${results.basicInfo.groupCounts[lot]} data points</td>
                                </tr>
                                `).join('') : ''}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Dashboard & Export Buttons -->
                    <div class="dashboard-action dashboard-action-layout">
                        <button class="btn btn-accent btn-min-width-180" onclick="openDashboard()" id="dashboardBtn">
                            <i class="fas fa-chart-pie"></i> Dashboard
                        </button>
                        <button class="btn btn-export btn-min-width-120" onclick="exportDashboard()" id="exportBtn">
                            <i class="fas fa-download"></i> Export Data
                        </button>
                    </div>
                `);
                content.appendChild(basicCard);
                
                // Debug: Check if buttons are created
                console.log('🔍 Dashboard button found:', document.getElementById('dashboardBtn'));
                console.log('🔍 Export button found:', document.getElementById('exportBtn'));

                // Store results for dashboard
                sessionStorage.setItem('anovaResults', JSON.stringify(results));

                // 1. Combined ANOVA Analysis Group (like Tukey results)
                console.log('📊 Creating combined ANOVA Analysis Group...');
                const anovaAnalysisCard = createCard(
                    ``, 
                    createAnovaAnalysisGroup(results, tableNames)
                );
                content.appendChild(anovaAnalysisCard);

                // 2. Tukey HSD Results (moved to be right after ANOVA Analysis Group)
                if (results.tukey) {
                    console.log('🔍 Creating Tukey results...');
                    const tukeyCard = createCard(`<i class="fas fa-search-plus"></i> ${tableNames.tukeyHsd}`, 
                        createTukeyResults(results, tableNames));
                    content.appendChild(tukeyCard);
                } else {
                    const noTukeyCard = createCard(`<i class="fas fa-search-plus"></i> ${tableNames.tukeyHsd}`, `
                        <div class="pre-formatted">
                            Tukey-Kramer HSD post-hoc analysis could not be performed due to insufficient data or missing statistical libraries.
                            Requirements: At least 2 groups with sufficient degrees of freedom.
                        </div>
                    `);
                    content.appendChild(noTukeyCard);
                }

                // 3. Combined Variance Analysis Group (like ANOVA and Tukey results)
                console.log('📈 Creating combined Variance Analysis Group...');
                const varianceAnalysisCard = createCard(
                    `<i class="fas fa-balance-scale"></i> Tests that the Variances are Equal`, 
                    createVarianceAnalysisGroup(results, tableNames)
                );
                content.appendChild(varianceAnalysisCard);

                // All variance-related analyses now combined in Variance Analysis Group

                // Oneway Analysis chart moved above means table
                if (false) { // Chart moved above
                    console.log('� Displaying Oneway Analysis chart...');
                    const onewayCard = createCard(`<i class="fas fa-chart-line"></i> ${tableNames.onewayAnalysis}`, `
                            <div class="chart-container" style="position: relative;">
                                <img src="data:image/png;base64,${results.plots.dotplot}" 
                                     alt="Oneway Analysis of Data by LOT" 
                                     data-chart-type="oneway"
                                     id="onewayChart"
                                     style="width: 100%; max-width: 100%;"
                                     title="Oneway Analysis Chart">
                                

                                <div style="text-align: center; margin-top: 12px; padding: 12px; background: var(--bg-secondary); border-radius: var(--radius); border: 1px solid var(--border-color);">

                                    <br>
                                    <small style="display: block; color: var(--text-secondary); margin-top: 8px;">
                                        Try: 1) Double-click the chart above, 2) Use Debug Chart button, 3) Use Force Add Listener
                                    </small>
                                </div>
                            </div>
                        `);
                        content.appendChild(onewayCard);
                        
                        // Add event listeners with multiple retry attempts
                        console.log('🔄 Attempting to add double-click listeners...');
                        
                        // Function to add listeners with retry
                        function addChartListeners(retryCount = 0) {
                            const maxRetries = 5;
                            const chartImg = document.getElementById('onewayChart');
                            
                            if (chartImg) {
                                console.log(`✅ Chart found on attempt ${retryCount + 1}`);
                            } else if (retryCount < maxRetries) {
                                console.log(`⏳ Chart not found, retrying... (${retryCount + 1}/${maxRetries})`);
                                setTimeout(() => addChartListeners(retryCount + 1), 1000);
                            } else {
                                console.log('❌ Failed to find chart after', maxRetries, 'attempts');
                            }
                        }
                        

                        
                        // Start adding listeners
                        setTimeout(() => addChartListeners(), 100);
                } else {
                    console.log('❌ No dotplot data found in results');
                }


                if (results.basicInfo && results.basicInfo.rawGroups) {
                    const flatData = [];
                    Object.keys(results.basicInfo.rawGroups).forEach(lot => {
                        results.basicInfo.rawGroups[lot].forEach(value => {
                            flatData.push({ LOT: lot, DATA: value });
                        });
                    });
                    

                } else {
                    console.log('❌ No raw data found in results');
                }



                // Show results
                loadingDiv.style.display = 'none';
                resultsContent.style.display = 'block';
                console.log('✅ All results displayed successfully');
                
                showSuccess('Analysis completed successfully!');
                
            } catch (error) {
                console.error('❌ Error in displayResults:', error);
                showError(`Error displaying results: ${error.message}`);
                hideLoading();
            }
        }

        // ฟังก์ชัน Export ข้อมูล analysis - Enhanced version with PowerPoint support
        function exportDashboard() {
            console.log('🎯 exportDashboard() called'); // Debug log
            
            try {
                // Create export options modal
            const modal = document.createElement('div');
            modal.className = 'export-modal';
            modal.innerHTML = `
                <div class="export-modal-content">
                    <div class="export-modal-header">
                        <h3><i class="fas fa-download"></i> Export Analysis Results</h3>
                        <button class="export-modal-close" onclick="closeExportModal()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="export-modal-body">
                        <div class="export-options">
                            <button class="export-option pdf-option" onclick="exportPDF()">
                                <div class="export-icon">
                                    <i class="fas fa-file-pdf"></i>
                                </div>
                                <div class="export-content">
                                    <span class="export-title">PDF Report</span>
                                    <small class="export-desc">Professional analysis report</small>
                                    <div class="export-features">
                                        <span>• Comprehensive analysis</span>
                                        <span>• Charts & tables</span>
                                        <span>• Publication ready</span>
                                    </div>
                                </div>
                            </button>
                            <button class="export-option ppt-option" onclick="exportPowerPoint()">
                                <div class="export-icon">
                                    <i class="fas fa-file-powerpoint"></i>
                                </div>
                                <div class="export-content">
                                    <span class="export-title">PowerPoint</span>
                                    <small class="export-desc">Presentation slides</small>
                                    <div class="export-features">
                                        <span>• Ready to present</span>
                                        <span>• Visual charts</span>
                                        <span>• Professional slides</span>
                                    </div>
                                </div>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Add CSS if not exists
            if (!document.querySelector('#exportModalCSS')) {
                const style = document.createElement('style');
                style.id = 'exportModalCSS';
                style.textContent = `
                    .export-modal {
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.7);
                        backdrop-filter: blur(8px);
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        z-index: 10000;
                        animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                    }
                    
                    .export-modal-content {
                        background: var(--bg-primary);
                        border-radius: 20px;
                        padding: 0;
                        max-width: 700px;
                        width: 95%;
                        max-height: 80vh;
                        overflow-y: auto;
                        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
                        border: 1px solid var(--border-color);
                        animation: slideInUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                    }
                    
                    .export-modal-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 2rem 2rem 1rem 2rem;
                        border-bottom: 1px solid var(--border-color);
                        background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
                        border-radius: 20px 20px 0 0;
                    }
                    
                    .export-modal-header h3 {
                        margin: 0;
                        color: var(--text-primary);
                        font-size: 1.5rem;
                        font-weight: 700;
                        display: flex;
                        align-items: center;
                        gap: 12px;
                    }
                    
                    .export-modal-header h3 i {
                        color: var(--accent-color);
                        font-size: 1.3rem;
                    }
                    
                    .export-modal-close {
                        background: rgba(255, 255, 255, 0.1);
                        border: none;
                        font-size: 1.2rem;
                        color: var(--text-secondary);
                        cursor: pointer;
                        padding: 10px;
                        border-radius: 50%;
                        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                        width: 40px;
                        height: 40px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    }
                    
                    .export-modal-close:hover {
                        background: rgba(239, 68, 68, 0.1);
                        color: #ef4444;
                        transform: rotate(90deg) scale(1.1);
                    }
                    
                    .export-modal-body {
                        padding: 2rem;
                    }
                    
                    .export-description {
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        padding: 1rem;
                        background: rgba(59, 130, 246, 0.1);
                        border: 1px solid rgba(59, 130, 246, 0.2);
                        border-radius: 12px;
                        margin-bottom: 2rem;
                    }
                    
                    .export-description i {
                        color: var(--accent-color);
                        font-size: 1.2rem;
                    }
                    
                    .export-description p {
                        margin: 0;
                        color: var(--text-secondary);
                        font-size: 0.95rem;
                        line-height: 1.5;
                    }
                    
                    .export-options {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                        gap: 1.5rem;
                    }
                    
                    .export-option {
                        display: flex;
                        align-items: flex-start;
                        gap: 1rem;
                        padding: 1.5rem;
                        border: 2px solid var(--border-color);
                        border-radius: 16px;
                        background: var(--bg-secondary);
                        cursor: pointer;
                        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                        position: relative;
                        overflow: hidden;
                    }
                    
                    .export-option::before {
                        content: '';
                        position: absolute;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: linear-gradient(135deg, transparent 0%, rgba(59, 130, 246, 0.1) 100%);
                        opacity: 0;
                        transition: opacity 0.3s ease;
                    }
                    
                    .export-option:hover::before {
                        opacity: 1;
                    }
                    
                    .export-option:hover {
                        border-color: var(--accent-color);
                        transform: translateY(-4px) scale(1.02);
                        box-shadow: 0 20px 40px -12px rgba(59, 130, 246, 0.3);
                    }
                    
                    .export-icon {
                        flex-shrink: 0;
                        width: 60px;
                        height: 60px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        border-radius: 12px;
                        transition: all 0.3s ease;
                    }
                    
                    .pdf-option .export-icon {
                        background: rgba(239, 68, 68, 0.1);
                        color: #ef4444;
                    }
                    
                    .excel-option .export-icon {
                        background: rgba(34, 197, 94, 0.1);
                        color: #22c55e;
                    }
                    
                    .ppt-option .export-icon {
                        background: rgba(249, 115, 22, 0.1);
                        color: #f97316;
                    }
                    
                    .json-option .export-icon {
                        background: rgba(168, 85, 247, 0.1);
                        color: #a855f7;
                    }
                    
                    .export-icon i {
                        font-size: 1.8rem;
                    }
                    
                    .export-content {
                        flex: 1;
                        text-align: left;
                    }
                    
                    .export-title {
                        display: block;
                        font-weight: 700;
                        font-size: 1.1rem;
                        color: var(--text-primary);
                        margin-bottom: 0.5rem;
                    }
                    
                    .export-desc {
                        display: block;
                        font-size: 0.9rem;
                        color: var(--text-secondary);
                        margin-bottom: 1rem;
                    }
                    
                    .export-features {
                        display: flex;
                        flex-direction: column;
                        gap: 0.25rem;
                    }
                    
                    .export-features span {
                        font-size: 0.8rem;
                        color: var(--text-secondary);
                        opacity: 0.8;
                    }
                    
                    @keyframes fadeIn {
                        from { 
                            opacity: 0; 
                        }
                        to { 
                            opacity: 1; 
                        }
                    }
                    
                    @keyframes slideInUp {
                        from { 
                            transform: translateY(60px) scale(0.95); 
                            opacity: 0; 
                        }
                        to { 
                            transform: translateY(0) scale(1); 
                            opacity: 1; 
                        }
                    }
                    
                    /* Responsive design */
                    @media (max-width: 768px) {
                        .export-modal-content {
                            width: 100%;
                            height: 100%;
                            max-height: 100vh;
                            border-radius: 0;
                            margin: 0;
                        }
                        
                        .export-modal-header {
                            border-radius: 0;
                        }
                        
                        .export-options {
                            grid-template-columns: 1fr;
                        }
                        
                        .export-option {
                            padding: 1rem;
                        }
                        
                        .export-icon {
                            width: 50px;
                            height: 50px;
                        }
                        
                        .export-icon i {
                            font-size: 1.5rem;
                        }
                    }
                `;
                document.head.appendChild(style);
            }
            } catch (error) {
                console.error('❌ Error in exportDashboard:', error);
            }
        }
        
        function closeExportModal() {
            const modal = document.querySelector('.export-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        function exportPDF() {
            closeExportModal();
            
            // Show loading indicator
            const exportBtn = document.querySelector('.btn-export') || document.getElementById('exportBtn');
            if (!exportBtn) {
                showNotification('Export button not found! Please refresh the page.', 'error');
                return;
            }
            
            const originalText = exportBtn.innerHTML;
            exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating PDF...';
            exportBtn.disabled = true;

            // Get stored analysis results
            const storedResults = sessionStorage.getItem('anovaResults');
            
            if (!storedResults) {
                showNotification('No analysis data available to export! Please run an analysis first.', 'error');
                exportBtn.innerHTML = originalText;
                exportBtn.disabled = false;
                return;
            }

            try {
                const fullResults = JSON.parse(storedResults);
                
                // Check if we have required data
                if (!fullResults.anova || !fullResults.basicInfo) {
                    showNotification('Incomplete analysis data. Please run the analysis again.', 'error');
                    exportBtn.innerHTML = originalText;
                    exportBtn.disabled = false;
                    return;
                }

                // ✅ ตรวจสอบความครบถ้วนของข้อมูลก่อน export
                const requiredSections = {
                    'Analysis of Variance': fullResults.anova,
                    'Means for Oneway Anova': fullResults.means?.groupStatsPooledSE,
                    'Means and Std Deviations': fullResults.means?.groupStatsIndividual,
                    'Confidence Quantile': fullResults.tukey?.qCrit,
                    'HSD Threshold Matrix': fullResults.tukey?.hsdMatrix,
                    'Connecting Letters Report': fullResults.tukey?.connectingLettersTable,
                    'Ordered Differences Report': fullResults.tukey?.comparisons,
                    'Tests that Variances are Equal': fullResults.levene || fullResults.bartlett,
                    'Welch\'s Test': fullResults.welch
                };
                
                const missingSections = [];
                for (const [section, data] of Object.entries(requiredSections)) {
                    if (!data) {
                        missingSections.push(section);
                    }
                }
                
                if (missingSections.length > 0) {
                    showNotification(`⚠️ Some sections are missing: ${missingSections.slice(0,2).join(', ')}${missingSections.length > 2 ? ' and others' : ''}. Export will continue with available data.`, 'warning');
                }

                // ✅ ส่งข้อมูลครบถ้วนไปยัง backend สำหรับ PDF generation
                fetch('/export_pdf', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        result: fullResults,
                        completeness: {
                            total: Object.keys(requiredSections).length,
                            available: Object.keys(requiredSections).length - missingSections.length,
                            missing: missingSections,
                            sections: requiredSections
                        }
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Create and download PDF file
                        const byteCharacters = atob(data.pdf_data);
                        const byteNumbers = new Array(byteCharacters.length);
                        for (let i = 0; i < byteCharacters.length; i++) {
                            byteNumbers[i] = byteCharacters.charCodeAt(i);
                        }
                        const byteArray = new Uint8Array(byteNumbers);
                        const pdfBlob = new Blob([byteArray], {type: 'application/pdf'});
                        
                        const link = document.createElement('a');
                        link.href = URL.createObjectURL(pdfBlob);
                        link.download = data.filename || `anova-analysis-${new Date().toISOString().split('T')[0]}.pdf`;
                        link.click();
                        
                        showNotification('PDF report generated and downloaded successfully!', 'success');
                    } else {
                        showNotification('Error generating PDF: ' + (data.error || 'Unknown error'), 'error');
                    }
                })
                .catch(error => {
                    console.error('Error generating PDF:', error);
                    showNotification('Error generating PDF! Please try again.', 'error');
                })
                .finally(() => {
                    exportBtn.innerHTML = originalText;
                    exportBtn.disabled = false;
                });
                
            } catch (error) {
                console.error('Error processing export data:', error);
                showNotification('Error processing export data!', 'error');
                exportBtn.innerHTML = originalText;
                exportBtn.disabled = false;
            }
        }
        
        function exportPowerPoint() {
            closeExportModal();
            
            // Get stored analysis results
            const storedResults = sessionStorage.getItem('anovaResults');
            
            if (!storedResults) {
                showNotification('No analysis data available for export! Please run an analysis first.', 'error');
                return;
            }
            
            try {
                const fullResults = JSON.parse(storedResults);
                
                // Check if we have required ANOVA data
                if (!fullResults.anova || !fullResults.basicInfo) {
                    showNotification('Incomplete analysis data. Please run the analysis again.', 'error');
                    return;
                }
                
                // Show loading indicator
                const exportBtn = document.querySelector('.btn-export') || document.getElementById('exportBtn');
                if (exportBtn) {
                    const originalText = exportBtn.innerHTML;
                    exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating PowerPoint...';
                    exportBtn.disabled = true;
                    
                    // Reconstruct data structure for PowerPoint export
                    // Create fake data structure that matches what backend expects
                    const reconstructedData = [];
                    
                    // Extract group information from basicInfo and means
                    if (fullResults.basicInfo && fullResults.basicInfo.lotNames && fullResults.means && fullResults.means.groupMeans) {
                        const groupMeans = fullResults.means.groupMeans;
                        const groupCounts = fullResults.basicInfo.groupCounts;
                        
                        // Generate representative data points for each group based on means and counts
                        for (const lotName of fullResults.basicInfo.lotNames) {
                            const count = groupCounts[lotName] || 1;
                            const mean = groupMeans[lotName];
                            
                            // Create data points around the mean (simplified reconstruction)
                            for (let i = 0; i < Math.min(count, 5); i++) { // Limit to 5 points per group
                                reconstructedData.push({
                                    [fullResults.basicInfo.lotNames[0].includes('LOT') ? 'LOT' : 'Group']: lotName,
                                    [fullResults.basicInfo.lotNames[0].includes('DATA') ? 'DATA' : 'Value']: mean + (Math.random() - 0.5) * 0.1 // Small variation around mean
                                });
                            }
                        }
                    }
                    
                    // ✅ เตรียมข้อมูลครบถ้วนทั้ง 9 หัวข้อสำหรับ PowerPoint export
                    const exportData = {
                        data: reconstructedData.length > 0 ? reconstructedData : [
                            // Fallback minimal data structure
                            { Group: 'A', Value: fullResults.means?.grandMean || 25 },
                            { Group: 'B', Value: (fullResults.means?.grandMean || 25) + 1 }
                        ],
                        result: {
                            // ✅ 1. Analysis of Variance
                            anova: {
                                fStatistic: fullResults.anova?.fStatistic || 0,
                                pValue: fullResults.anova?.pValue || 0,
                                dfBetween: fullResults.anova?.dfBetween || 0,
                                dfWithin: fullResults.anova?.dfWithin || 0,
                                dfTotal: fullResults.anova?.dfTotal || 0,
                                ssBetween: fullResults.anova?.ssBetween || 0,
                                ssWithin: fullResults.anova?.ssWithin || 0,
                                ssTotal: fullResults.anova?.ssTotal || 0,
                                msBetween: fullResults.anova?.msBetween || 0,
                                msWithin: fullResults.anova?.msWithin || 0
                            },
                            
                            // ✅ 2. Means for Oneway Anova + 3. Means and Std Deviations
                            means: {
                                groupStatsPooledSE: fullResults.means?.groupStatsPooledSE || [],
                                groupStatsIndividual: fullResults.means?.groupStatsIndividual || [],
                                groupMeans: fullResults.means?.groupMeans || {},
                                grandMean: fullResults.means?.grandMean || 0,
                                pooledSE: fullResults.means?.pooledSE || 0
                            },
                            
                            // ✅ 4. Confidence Quantile + 5. HSD Threshold Matrix + 6. Connecting Letters + 7. Ordered Differences
                            tukey: {
                                qCrit: fullResults.tukey?.qCrit || 0,
                                hsd: fullResults.tukey?.hsd || 0,
                                hsdMatrix: fullResults.tukey?.hsdMatrix || {},
                                connectingLettersTable: fullResults.tukey?.connectingLettersTable || [],
                                comparisons: fullResults.tukey?.comparisons || [],
                                available: fullResults.tukey?.available || false
                            },
                            
                            // ✅ 8. Tests that the Variances are Equal
                            levene: {
                                statistic: fullResults.levene?.statistic || 0,
                                pValue: fullResults.levene?.pValue || 0,
                                available: fullResults.levene?.available || false
                            },
                            bartlett: {
                                statistic: fullResults.bartlett?.statistic || 0,
                                pValue: fullResults.bartlett?.pValue || 0,
                                available: fullResults.bartlett?.available || false
                            },
                            brownForsythe: {
                                statistic: fullResults.brownForsythe?.statistic || 0,
                                pValue: fullResults.brownForsythe?.pValue || 0,
                                available: fullResults.brownForsythe?.available || false
                            },
                            obrien: {
                                statistic: fullResults.obrien?.statistic || 0,
                                pValue: fullResults.obrien?.pValue || 0,
                                available: fullResults.obrien?.available || false
                            },
                            
                            // ✅ 9. Welch's Test
                            welch: {
                                statistic: fullResults.welch?.statistic || 0,
                                pValue: fullResults.welch?.pValue || 0,
                                dfNumerator: fullResults.welch?.dfNumerator || 0,
                                dfDenominator: fullResults.welch?.dfDenominator || 0,
                                available: fullResults.welch?.available || false
                            },
                            
                            // Basic information
                            basicInfo: {
                                totalSamples: fullResults.basicInfo?.totalSamples || 0,
                                numLots: fullResults.basicInfo?.numLots || 0,
                                lotNames: fullResults.basicInfo?.lotNames || [],
                                groupCounts: fullResults.basicInfo?.groupCounts || {},
                                rawGroups: fullResults.basicInfo?.rawGroups || {}
                            },
                            
                            // Charts data
                            plots: fullResults.plots || {}
                        },
                        completeness: {
                            analysisOfVariance: !!(fullResults.anova?.fStatistic),
                            meansForOnewayAnova: !!(fullResults.means?.groupStatsPooledSE?.length),
                            meansAndStdDeviations: !!(fullResults.means?.groupStatsIndividual?.length),
                            confidenceQuantile: !!(fullResults.tukey?.qCrit),
                            hsdThresholdMatrix: !!(fullResults.tukey?.hsdMatrix),
                            connectingLettersReport: !!(fullResults.tukey?.connectingLettersTable?.length),
                            orderedDifferencesReport: !!(fullResults.tukey?.comparisons?.length),
                            testsVariancesEqual: !!(fullResults.levene?.available || fullResults.bartlett?.available),
                            welchTest: !!(fullResults.welch?.available)
                        }
                    };
                    
                    console.log('Sending PowerPoint export data:', exportData);
                    
                    fetch('/export_powerpoint', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(exportData)
                    })
                    .then(response => {
                        console.log('PowerPoint export response status:', response.status);
                        if (!response.ok) {
                            return response.json().then(err => Promise.reject(err));
                        }
                        return response.blob();
                    })
                    .then(blob => {
                        console.log('PowerPoint blob received, size:', blob.size);
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.style.display = 'none';
                        a.href = url;
                        a.download = `ANOVA_Analysis_Report_${new Date().toISOString().slice(0,19).replace(/:/g, '-')}.pptx`;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        
                        showNotification('PowerPoint presentation downloaded successfully!', 'success');
                    })
                    .catch(error => {
                        console.error('PowerPoint export error:', error);
                        showNotification(error.error || 'Failed to export PowerPoint presentation', 'error');
                    })
                    .finally(() => {
                        if (exportBtn) {
                            exportBtn.innerHTML = originalText;
                            exportBtn.disabled = false;
                        }
                    });
                } else {
                    // Direct fetch without button updates
                    const reconstructedData = [];
                    
                    // Extract group information from basicInfo and means
                    if (fullResults.basicInfo && fullResults.basicInfo.lotNames && fullResults.means && fullResults.means.groupMeans) {
                        const groupMeans = fullResults.means.groupMeans;
                        const groupCounts = fullResults.basicInfo.groupCounts;
                        
                        // Generate representative data points for each group based on means and counts
                        for (const lotName of fullResults.basicInfo.lotNames) {
                            const count = groupCounts[lotName] || 1;
                            const mean = groupMeans[lotName];
                            
                            // Create data points around the mean (simplified reconstruction)
                            for (let i = 0; i < Math.min(count, 5); i++) { // Limit to 5 points per group
                                reconstructedData.push({
                                    [fullResults.basicInfo.lotNames[0].includes('LOT') ? 'LOT' : 'Group']: lotName,
                                    [fullResults.basicInfo.lotNames[0].includes('DATA') ? 'DATA' : 'Value']: mean + (Math.random() - 0.5) * 0.1 // Small variation around mean
                                });
                            }
                        }
                    }
                    
                    const exportData = {
                        data: reconstructedData.length > 0 ? reconstructedData : [
                            // Fallback minimal data structure
                            { Group: 'A', Value: fullResults.means?.grandMean || 25 },
                            { Group: 'B', Value: (fullResults.means?.grandMean || 25) + 1 }
                        ],
                        result: {
                            f_statistic: fullResults.anova.fStatistic,
                            p_value: fullResults.anova.pValue,
                            df_between: fullResults.anova.dfBetween,
                            df_within: fullResults.anova.dfWithin,
                            df_total: fullResults.anova.dfTotal,
                            ss_between: fullResults.anova.ssBetween,
                            ss_within: fullResults.anova.ssWithin,
                            ss_total: fullResults.anova.ssTotal,
                            ms_between: fullResults.anova.msBetween,
                            ms_within: fullResults.anova.msWithin
                        },
                        charts_data: fullResults.plots || {}
                    };
                    
                    console.log('Sending PowerPoint export data (no button):', exportData);
                    
                    fetch('/export_powerpoint', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(exportData)
                    })
                    .then(response => {
                        console.log('PowerPoint export response status:', response.status);
                        if (!response.ok) {
                            return response.json().then(err => Promise.reject(err));
                        }
                        return response.blob();
                    })
                    .then(blob => {
                        console.log('PowerPoint blob received, size:', blob.size);
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.style.display = 'none';
                        a.href = url;
                        a.download = `ANOVA_Analysis_Report_${new Date().toISOString().slice(0,19).replace(/:/g, '-')}.pptx`;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        
                        showNotification('PowerPoint presentation downloaded successfully!', 'success');
                    })
                    .catch(error => {
                        console.error('PowerPoint export error:', error);
                        showNotification(error.error || 'Failed to export PowerPoint presentation', 'error');
                    });
                }
                
            } catch (error) {
                console.error('Error preparing export data:', error);
                showNotification('Error preparing data for export!', 'error');
            }
        }



        // Notification system - Same as dashboard.html
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
                ${message}
            `;
            
            // Add styles
            notification.style.cssText = `
                position: fixed;
                top: 90px;
                right: 30px;
                background: ${type === 'success' ? 'var(--success-color)' : type === 'error' ? 'var(--error-color)' : 'var(--primary-color)'};
                color: white;
                padding: 15px 20px;
                border-radius: var(--radius);
                box-shadow: var(--shadow-lg);
                z-index: 1001;
                display: flex;
                align-items: center;
                gap: 10px;
                animation: slideInRight 0.3s ease;
                max-width: 300px;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                font-size: 0.9rem;
                font-weight: 500;
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // Add CSS animations for notifications - Ensure this runs immediately
        (function() {
            if (!document.getElementById('notificationStyles')) {
                const style = document.createElement('style');
                style.id = 'notificationStyles';
                style.textContent = `
                    @keyframes slideInRight {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    
                    @keyframes slideOutRight {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(100%); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }
        })();

        // Test function for notification system (for debugging)
        function testNotification() {
            console.log('Testing notification...');
            showNotification('Test notification working!', 'success');
        }

        // Make testNotification available globally for console testing
        window.testNotification = testNotification;

        // Function to preview export data (for debugging)
        function previewExportData() {
            const storedResults = sessionStorage.getItem('anovaResults');
            if (!storedResults) {
                console.log('No analysis data found');
                return;
            }

            const fullResults = JSON.parse(storedResults);
            const filteredResults = {
                ...(fullResults.means && { means: fullResults.means }),
                ...(fullResults.anova && { anova: fullResults.anova }),
                ...(fullResults.levene && { levene: fullResults.levene }),
                ...(fullResults.brownForsythe && { brownForsythe: fullResults.brownForsythe }),
                ...(fullResults.bartlett && { bartlett: fullResults.bartlett }),
                ...(fullResults.madStats && { madStats: fullResults.madStats }),
                ...(fullResults.tukey && { tukey: fullResults.tukey }),
                ...(fullResults.plots && { plots: fullResults.plots })
            };

            console.log('🔍 Export Preview:');
            console.log('📊 Full data keys:', Object.keys(fullResults));
            console.log('📋 Filtered data keys (will be exported):', Object.keys(filteredResults));
            console.log('❌ Excluded: basicInfo');
            return filteredResults;
        }

        // Make previewExportData available globally for console testing
        window.previewExportData = previewExportData;

        function createCard(title, contentHtml) {
            const card = document.createElement('div');
            card.className = 'result-card';
            card.innerHTML = `
                <h3>${title}</h3>
                ${contentHtml}
            `;
            return card;
        }

        function createANOVATable(anova) {
            // Function to get color based on p-value significance
            function getPValueColor(pValue) {
                if (pValue < 0.05) {
                    return 'style="color: #F44336; font-weight: bold;"'; // Red for significant
                } else {
                    return 'style="color: #4CAF50; font-weight: bold;"'; // Green for not significant
                }
            }
            
            return `
                <div class="table-container">
                    <table class="anova-table">
                        <thead>
                            <tr>
                                <th>Source</th>
                                <th>DF</th>
                                <th>Sum of Squares</th>
                                <th>Mean Square</th>
                                <th>F Ratio</th>
                                <th>Prob > F</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Lot</td>
                                <td>${anova.dfBetween}</td>
                                <td>${anova.ssBetween.toFixed(8)}</td>
                                <td>${anova.msBetween.toExponential(6)}</td>
                                <td>${anova.fStatistic.toFixed(4)}</td>
                                <td ${getPValueColor(anova.pValue)}>${anova.pValue.toFixed(4)}</td>
                            </tr>
                            <tr>
                                <td>Error</td>
                                <td>${anova.dfWithin}</td>
                                <td>${anova.ssWithin.toFixed(8)}</td>
                                <td>${anova.msWithin.toExponential(6)}</td>
                                <td></td>
                                <td></td>
                            </tr>
                            <tr>
                                <td>C Total</td>
                                <td>${anova.dfTotal}</td>
                                <td>${anova.ssTotal.toFixed(8)}</td>
                                <td></td>
                                <td></td>
                                <td></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
        }

        function createWelchTable(welch) {
            // Function to get color based on p-value significance
            function getPValueColor(pValue) {
                if (pValue < 0.05) {
                    return 'style="color: #F44336; font-weight: bold;"'; // Red for significant
                } else {
                    return 'style="color: #4CAF50; font-weight: bold;"'; // Green for not significant
                }
            }
            
            return `
                <div class="table-container">
                    <h4 class="margin-bottom-10 text-primary-color">Welch Anova testing Means Equal, allowing Std Devs Not Equal</h4>
                    <table class="anova-table">
                        <thead>
                            <tr>
                                <th>F Ratio</th>
                                <th>DFNum</th>
                                <th>DFDen</th>
                                <th>Prob > F</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>${welch.fStatistic.toFixed(4)}</td>
                                <td>${Math.round(welch.dfNum)}</td>
                                <td>${welch.dfDen.toFixed(3)}</td>
                                <td ${getPValueColor(welch.pValue)}>${welch.pValue.toFixed(4)}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
        }

        function createVarianceAnalysisGroup(results, tableNames = {}) {
            let content = '';
            
            // 1. Variance Chart
            if (results.plots?.varianceChart) {
                content += `
                    <div class="chart-container" style="margin-bottom: 20px;">
                        <img src="data:image/png;base64,${results.plots.varianceChart}" alt="Variance Chart">
                    </div>
                `;
            }
            
            // 2. Mean Absolute Deviations
            if (results.madStats) {
                content += `
                    <div style="margin-bottom: 20px;">
                        ${createMADTable(results.madStats)}
                    </div>
                `;
            }
            
            // 3. Tests that the Variances are Equal
            if (results.levene || results.brownForsythe || results.bartlett) {
                // Function to get color based on p-value significance
                function getPValueColor(pValue) {
                    if (pValue < 0.05) {
                        return 'style="color: #F44336; font-weight: bold;"'; // Red for significant
                    } else {
                        return 'style="color: #4CAF50; font-weight: bold;"'; // Green for not significant
                    }
                }
                
                content += `
                    <div class="table-container" style="margin-bottom: 20px;">
                        <table>
                            <thead>
                                <tr><th>Test</th><th>F Ratio / Stat</th><th>DFNum</th><th>DFDen</th><th>Prob > F</th></tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>O'Brien[.5]</td>
                                    <td>${safeToFixed(results.obrien?.fStatistic, 4)}</td>
                                    <td>${results.obrien?.dfNum !== null && !isNaN(results.obrien?.dfNum) ? results.obrien.dfNum : 'N/A'}</td>
                                    <td>${results.obrien?.dfDen !== null && !isNaN(results.obrien?.dfDen) ? results.obrien.dfDen : 'N/A'}</td>
                                    <td ${results.obrien?.pValue ? getPValueColor(results.obrien.pValue) : ''}>${safeToFixed(results.obrien?.pValue, 4)}</td>
                                </tr>
                                <tr>
                                    <td>Brown-Forsythe</td>
                                    <td>${results.brownForsythe?.fStatistic !== null && !isNaN(results.brownForsythe?.fStatistic) ? results.brownForsythe.fStatistic.toFixed(4) : 'N/A'}</td>
                                    <td>${results.brownForsythe?.dfNum !== null && !isNaN(results.brownForsythe?.dfNum) ? results.brownForsythe.dfNum : 'N/A'}</td>
                                    <td>${results.brownForsythe?.dfDen !== null && !isNaN(results.brownForsythe?.dfDen) ? results.brownForsythe.dfDen : 'N/A'}</td>
                                    <td ${results.brownForsythe?.pValue ? getPValueColor(results.brownForsythe.pValue) : ''}>${results.brownForsythe?.pValue !== null && !isNaN(results.brownForsythe?.pValue) ? results.brownForsythe.pValue.toFixed(4) : 'N/A'}</td>
                                </tr>
                                <tr>
                                    <td>Levene</td>
                                    <td>${results.levene?.fStatistic !== null && !isNaN(results.levene?.fStatistic) ? results.levene.fStatistic.toFixed(4) : 'N/A'}</td>
                                    <td>${results.levene?.dfNum !== null && !isNaN(results.levene?.dfNum) ? results.levene.dfNum : 'N/A'}</td>
                                    <td>${results.levene?.dfDen !== null && !isNaN(results.levene?.dfDen) ? results.levene.dfDen : 'N/A'}</td>
                                    <td ${results.levene?.pValue ? getPValueColor(results.levene.pValue) : ''}>${results.levene?.pValue !== null && !isNaN(results.levene?.pValue) ? results.levene.pValue.toFixed(4) : 'N/A'}</td>
                                </tr>
                                <tr>
                                    <td>Bartlett</td>
                                    <td>${results.bartlett?.statistic !== null && !isNaN(results.bartlett?.statistic) ? results.bartlett.statistic.toFixed(4) : 'N/A'}</td>
                                    <td>${results.bartlett?.dfNum !== null && !isNaN(results.bartlett?.dfNum) ? results.bartlett.dfNum : 'N/A'}</td>
                                    <td></td>
                                    <td ${results.bartlett?.pValue ? getPValueColor(results.bartlett.pValue) : ''}>${results.bartlett?.pValue !== null && !isNaN(results.bartlett?.pValue) ? results.bartlett.pValue.toFixed(4) : 'N/A'}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            // 4. Welch's Test
            if (results.welch && results.welch.available && results.welch.fStatistic !== null) {
                content += `
                    <h4><i class="fas fa-calculator"></i> ${tableNames.welchTest || "Welch's Test"}</h4>
                    <div style="margin-bottom: 20px;">
                        ${createWelchTable(results.welch)}
                    </div>
                `;
            }
            
            return content;
        }

        function createAnovaAnalysisGroup(results, tableNames = {}) {
            let content = '';
            
            // 1. Oneway Analysis Plot
            if (results.plots?.onewayAnalysisPlot) {
                content += `
                    <h4><i class="fas fa-chart-column"></i> Oneway Analysis of Data By LOT</h4>
                    <div class="chart-container" style="margin-bottom: 20px;">
                        <img src="data:image/png;base64,${results.plots.onewayAnalysisPlot}" alt="Oneway Analysis Plot">
                    </div>
                `;
            }
            
            // 2. Oneway Analysis Chart (dotplot)
            if (results.plots && results.plots.dotplot) {
                content += `
                    <h4><i class="fas fa-chart-line"></i> Oneway Analysis Chart</h4>
                    <div class="chart-container" style="position: relative; margin-bottom: 20px;">
                        <img src="data:image/png;base64,${results.plots.dotplot}" 
                             alt="Oneway Analysis of Data by LOT" 
                             data-chart-type="oneway"
                             id="onewayChart"
                             style="width: 100%; max-width: 100%;"
                             title="Oneway Analysis Chart">
                    </div>
                `;
            }
            
            // 3. Analysis of Variance Table
            if (results.anova) {
                content += `
                    <h4><i class="fas fa-calculator"></i> Analysis of Variance</h4>
                    ${createANOVATable(results.anova)}
                `;
            }
            
            // 4. Means for Oneway ANOVA
            if (results.means?.groupStatsPooledSE) {
                content += `
                    <h4><i class="fas fa-chart-line"></i> Means for Oneway ANOVA</h4>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr><th>Level</th><th>Number</th><th>Mean</th><th>Std Error</th><th>Lower 95%</th><th>Upper 95%</th></tr>
                            </thead>
                            <tbody>
                                ${results.means.groupStatsPooledSE.map(row => `
                                    <tr>
                                        <td>${row.Level}</td>
                                        <td>${row.Number}</td>
                                        <td>${row.Mean != null && !isNaN(row.Mean) ? row.Mean.toFixed(6) : 'N/A'}</td>
                                        <td>${row['Std Error'] != null && !isNaN(row['Std Error']) ? row['Std Error'].toFixed(6) : 'N/A'}</td>
                                        <td>${row['Lower 95%'] != null && !isNaN(row['Lower 95%']) ? row['Lower 95%'].toFixed(5) : 'N/A'}</td>
                                        <td>${row['Upper 95%'] != null && !isNaN(row['Upper 95%']) ? row['Upper 95%'].toFixed(5) : 'N/A'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            // 5. Means and Std Deviations
            if (results.means?.groupStatsIndividual) {
                content += `
                    <h4><i class="fas fa-table"></i> Means and Std Deviations</h4>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr><th>Level</th><th>Number</th><th>Mean</th><th>Std Dev</th><th>Std Err Mean</th><th>Lower 95%</th><th>Upper 95%</th></tr>
                            </thead>
                            <tbody>
                                ${results.means.groupStatsIndividual.map(row => `
                                    <tr>
                                        <td>${row.Level}</td>
                                        <td>${row.Number}</td>
                                        <td>${row.Mean != null && !isNaN(row.Mean) ? row.Mean.toFixed(7) : 'N/A'}</td>
                                        <td>${row['Std Dev'] !== null && !isNaN(row['Std Dev']) ? row['Std Dev'].toFixed(7) : '       NaN '}</td>
                                        <td>${row['Std Err'] !== null && !isNaN(row['Std Err']) ? row['Std Err'].toFixed(7) : '       NaN '}</td>
                                        <td>${row['Lower 95%'] !== null && !isNaN(row['Lower 95%']) ? row['Lower 95%'].toFixed(7) : '       NaN '}</td>
                                        <td>${row['Upper 95%'] !== null && !isNaN(row['Upper 95%']) ? row['Upper 95%'].toFixed(7) : '       NaN '}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            return content;
        }

        function createTukeyResults(results, tableNames = {}) {
            console.log("🔍 Debug Tukey Results:", results);
            console.log("🔍 Debug HSD Matrix:", results.tukey.hsdMatrix);
            console.log("🔍 Debug Comparisons Data:", results.tukey.comparisons);
            console.log("🔍 Debug Connecting Letters:", results.tukey.connectingLettersTable);
            
            // Function to create smaller Tukey chart (to be placed after tables)
            let tukeyChartContent = '';
            if (results.plots && results.plots.tukeyChart) {
                console.log("✅ Tukey chart found, will add after tables");
                tukeyChartContent = `
                    <h4>Tukey-Kramer HSD Post-hoc Analysis:</h4>
                    <div class="chart-container" style="margin: 20px auto; max-width: 70%; text-align: center;">
                        <img src="data:image/png;base64,${results.plots.tukeyChart}" 
                             alt="Tukey HSD Confidence Intervals" 
                             style="width: 100%; max-width: 600px; border-radius: var(--radius); border: 1px solid var(--border-color);">
                    </div>
                `;
            } else {
                console.warn("⚠️ Tukey chart not found in results.plots");
                console.log("Available plots:", Object.keys(results.plots || {}));
            }
            
            // Function to get color based on p-value significance
            function getPValueColor(pValue) {
                if (pValue < 0.05) {
                    return 'style="color: #F44336; font-weight: bold;"'; // Red for significant
                } else {
                    return 'style="color: #4CAF50; font-weight: bold;"'; // Green for not significant
                }
            }
            
            const alpha = 0.05;
            const connectingLettersData = results.tukey.connectingLettersTable;
            const comparisonsData = results.tukey.comparisons;

            // 2. HSD Threshold Matrix as a proper table
            let hsdThresholdSection = `
                <h4>${tableNames.confidenceQuantile || 'Confidence Quantile'}:</h4>
                <div class="compact-table-container">
                    <table class="compact-quantile-table">
                        <thead>
                            <tr>
                                <th>q*</th>
                                <th>Alpha</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>${results.tukey.qCrit.toFixed(5)}</td>
                                <td>${alpha}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <h4>${tableNames.hsdMatrix || 'HSD Threshold Matrix'}:</h4>
                <h5>Abs(Dif)-HSD</h5>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>&nbsp;</th>`;

            // สร้าง HSD Threshold Matrix แบบตาราง
            if (results.tukey.hsdMatrix && Object.keys(results.tukey.hsdMatrix).length > 0) {
                console.log("✅ HSD Matrix data found, creating table...");
                const lots = Object.keys(results.tukey.hsdMatrix);
                console.log("📊 Lots:", lots);
                
                // Header row with lot names
                lots.forEach(lot => {
                    hsdThresholdSection += `<th>${lot}</th>`;
                });
                hsdThresholdSection += `
                            </tr>
                        </thead>
                        <tbody>`;
                
                // Data rows
                lots.forEach(lot1 => {
                    hsdThresholdSection += `
                            <tr>
                                <td>${lot1}</td>`;
                    lots.forEach(lot2 => {
                        const value = results.tukey.hsdMatrix[lot1][lot2];
                        let cellValue = '';
                        
                        console.log(`🔍 Matrix value [${lot1}][${lot2}]:`, value);
                        
                        if (value !== undefined && value !== null && !isNaN(value)) {
                            cellValue = value.toFixed(5);  // 5 decimal places like Connecting Letters Report
                        } else {
                            cellValue = 'N/A';
                        }
                        
                        hsdThresholdSection += `<td>${cellValue}</td>`;
                    });
                    hsdThresholdSection += `</tr>`;
                });
                
                hsdThresholdSection += `
                        </tbody>
                    </table>
                </div>`;
            } else {
                console.error("❌ HSD Matrix data not found or empty!");
                console.log("Available tukey keys:", Object.keys(results.tukey || {}));
                hsdThresholdSection += `
                    <table>
                        <thead>
                            <tr><th style="background: var(--error-color); color: white;">Error</th></tr>
                        </thead>
                        <tbody>
                            <tr><td style="color: var(--error-color); text-align: center; padding: 20px;">HSD Matrix data not available</td></tr>
                        </tbody>
                    </table>
                </div>`;
            }

            // 2. Connecting Letters Table
            let connectingLettersTable = `
                <h4>${tableNames.connectingLetters || 'Connecting Letters Report'}:</h4>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr><th>Level</th><th>Mean</th><th>Std Error</th></tr>
                        </thead>
                        <tbody>
            `;

            connectingLettersData.forEach(row => {
                connectingLettersTable += `
                    <tr>
                        <td>${row.Level}</td>
                        <td>${row.Mean.toFixed(5)}</td>
                        <td>${row['Std Error'].toFixed(5)}</td>
                    </tr>
                `;
            });
            connectingLettersTable += `
                        </tbody>
                    </table>
                </div>
            `;

            // 3. Pairwise Comparisons Table
            let comparisonsTable = `
                <h4>${tableNames.orderedDifferences || 'Ordered Differences Report'} (Pairwise Comparisons):</h4>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Level</th>
                                <th>- Level</th>
                                <th>Difference</th>
                                <th>Std Err Dif</th>
                                <th>Lower CL</th>
                                <th>Upper CL</th>
                                <th>p-Value</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            // Check if comparisonsData exists and has content
            if (comparisonsData && comparisonsData.length > 0) {
                console.log("✅ Comparisons data found:", comparisonsData.length, "comparisons");
                comparisonsData.forEach(comp => {
                const isSignificant = comp.p_adj && comp.p_adj < alpha;
                const rowClass = isSignificant ? 'style="background-color: #fff3cd;"' : '';
                
                comparisonsTable += `
                    <tr ${rowClass}>
                        <td>${comp.lot1}</td>
                        <td>${comp.lot2}</td>
                        <td>${comp.rawDiff.toFixed(7)}</td>
                        <td>${comp.stdErrDiff.toFixed(7)}</td>
                        <td>${comp.lowerCL.toFixed(7)}</td>
                        <td>${comp.upperCL.toFixed(7)}</td>
                        <td ${comp.p_adj ? getPValueColor(comp.p_adj) : ''}><strong>${comp.p_adj ? comp.p_adj.toFixed(4) : 'N/A'}</strong></td>
                    </tr>
                `;
                });
            } else {
                console.error("❌ No comparisons data found!");
                comparisonsTable += `
                    <tr>
                        <td colspan="7" style="text-align: center; color: var(--error-color); padding: 20px;">
                            No pairwise comparison data available
                        </td>
                    </tr>
                `;
            }
            
            comparisonsTable += `
                        </tbody>
                    </table>
                </div>
            `;

            return hsdThresholdSection + connectingLettersTable + comparisonsTable + tukeyChartContent;
        }

        function createMADTable(madStats) {
            return `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Level</th>
                                <th>Count</th>
                                <th>Std Dev</th>
                                <th>MeanAbsDif to Mean</th>
                                <th>MeanAbsDif to Median</th>
                            </tr>
                        </thead>
                        <tbody>
            ${madStats.map(row => `
                                <tr>
                                    <td>${row.Level}</td>
                                    <td>${row.Count}</td>
                                    <td>${row['Std Dev'] !== null && !isNaN(row['Std Dev']) ? row['Std Dev'].toFixed(7) : '         NaN '}</td>
                                    <td>${row['MeanAbsDif to Mean'].toFixed(7)}</td>
                                    <td>${row['MeanAbsDif to Median'].toFixed(7)}</td>
                                </tr>
            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }


        function showMessage(message, type) {
            let messageDiv = document.getElementById('messageArea');
            if (!messageDiv) {
                messageDiv = document.createElement('div');
                messageDiv.id = 'messageArea';
                messageDiv.style.marginTop = '10px';
                // Adjust where messageArea is appended for better visibility
                // For example, right after the analyze button
                analyzeBtn.parentNode.insertBefore(messageDiv, analyzeBtn.nextSibling);
            }
            messageDiv.className = type;
            messageDiv.innerHTML = message;
        }

        function showError(message) {
            showMessage(message, 'error');
        }

        function showSuccess(message) {
            showMessage(message, 'success');
        }

        // เพิ่มฟังก์ชันทดสอบการเชื่อมต่อ
        async function testConnection() {
            console.log('🔍 Testing server connection...');
            try {
                const response = await fetch('/health');
                if (response.ok) {
                    console.log('✅ Server connection OK');
                    return true;
                } else {
                    console.log('❌ Server health check failed:', response.status);
                    return false;
                }
            } catch (error) {
                console.log('❌ Cannot connect to server:', error.message);
                return false;
            }
        }


        // ฟังก์ชันโหลดผลลัพธ์ล่าสุดจาก sessionStorage เมื่อเปิดหน้าเว็บ
        function loadLastResults() {
            const lastResults = sessionStorage.getItem('anovaResults');
            if (lastResults) {
                try {
                    const results = JSON.parse(lastResults);
                    // แสดงผลลัพธ์ทันที
                    resultsSection.style.display = 'block';
                    resultsSection.classList.add('visible');
                    loadingDiv.style.display = 'none';
                    resultsContent.style.display = 'block';
                    displayResults(results);
                    
                    // Test notification system
                    console.log('Testing notification system...');
                    // showNotification('Previous results loaded!', 'info');
                } catch (e) {
                    console.error('Error loading last results:', e);
                }
            }
        }

        // เรียกทดสอบการเชื่อมต่อและโหลดผลลัพธ์ล่าสุดเมื่อโหลดหน้า
        window.addEventListener('load', async () => {
            console.log('🚀 Page loaded, testing connection...');
            const isConnected = await testConnection();
            if (!isConnected) {
                showError('Cannot connect to Flask server. Please make sure the server is running on port 10000.');
            } else {
                console.log('✅ Ready for analysis');
                loadLastResults();
            }
        });

        // Theme functionality removed - using fixed light theme

        function openDashboard() {
            console.log('🎯 openDashboard() called');
            try {
                // Open the dashboard in a new tab or window
                const dashboardUrl = '/dashboard'; // Update this URL to your actual dashboard URL
                console.log('🚀 Opening dashboard at:', dashboardUrl);
                window.open(dashboardUrl, '_blank');
            } catch (error) {
                console.error('❌ Error opening dashboard:', error);
            }
        }
        
        // Test function for debugging
        function testButtons() {
            console.log('🧪 Testing buttons...');
            const dashBtn = document.getElementById('dashboardBtn');
            const expBtn = document.getElementById('exportBtn');
            console.log('Dashboard button:', dashBtn);
            console.log('Export button:', expBtn);
            
            if (dashBtn) {
                console.log('Dashboard button style:', window.getComputedStyle(dashBtn));
                console.log('Dashboard button onclick:', dashBtn.onclick);
            }
            
            if (expBtn) {
                console.log('Export button style:', window.getComputedStyle(expBtn));
                console.log('Export button onclick:', expBtn.onclick);
            }
        }
        
        // Make test function available globally
        window.testButtons = testButtons;



        

        

        

        

        


        // Load version info when page loads - DISABLED
        // document.addEventListener('DOMContentLoaded', loadVersionInfo);
    </script>



        <!-- Results Panel -->
        <div class="results-panel" id="resultsPanel">
            <div class="results-panel-header">
                <h3><i class="fas fa-chart-bar"></i> Analysis Results</h3>
                <button class="results-panel-close" id="resultsClose" aria-label="Close Results Panel">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="results-panel-content">
                <div class="results-message" id="resultsMessage">
                    <i class="fas fa-info-circle"></i>
                    <p>Run an analysis first to view results</p>
                </div>
                <div class="results-links" id="resultsLinks">
                    <h4>Analysis Sections</h4>
                    <ul class="results-list">
                        <li class="results-item">
                            <a href="#" class="results-link" data-section="basic-info">
                                <i class="fas fa-info-circle"></i>
                                <span>Basic Information</span>
                            </a>
                        </li>
                        <li class="results-item">
                            <a href="#" class="results-link" data-section="descriptive-stats">
                                <i class="fas fa-chart-pie"></i>
                                <span>Descriptive Statistics</span>
                            </a>
                        </li>
                        <li class="results-item">
                            <a href="#" class="results-link" data-section="anova-table">
                                <i class="fas fa-table"></i>
                                <span>ANOVA Table</span>
                            </a>
                        </li>
                        <li class="results-item">
                            <a href="#" class="results-link" data-section="variance-tests">
                                <i class="fas fa-vials"></i>
                                <span>Variance Tests</span>
                            </a>
                        </li>
                        <li class="results-item">
                            <a href="#" class="results-link" data-section="post-hoc">
                                <i class="fas fa-search-plus"></i>
                                <span>Post-Hoc Tests</span>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="results-panel-overlay" id="resultsOverlay"></div>

        <!-- Simple Footer -->
        <footer class="simple-footer">
            <div class="footer-container">
            </div>
        </footer>
    </main>

    <script>
        // Sidebar functionality
        document.addEventListener('DOMContentLoaded', function() {
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            const mainContent = document.getElementById('mainContent');
            let sidebarOpen = false;

            function toggleSidebar() {
                sidebarOpen = !sidebarOpen;
                
                if (sidebarOpen) {
                    sidebar.classList.add('open');
                    sidebarOverlay.classList.add('show');
                    
                    // On desktop, shift main content
                    if (window.innerWidth > 768) {
                        mainContent.classList.add('shifted');
                    }
                } else {
                    sidebar.classList.remove('open');
                    sidebarOverlay.classList.remove('show');
                    mainContent.classList.remove('shifted');
                }
            }

            function closeSidebar() {
                if (sidebarOpen) {
                    sidebarOpen = false;
                    sidebar.classList.remove('open');
                    sidebarOverlay.classList.remove('show');
                    mainContent.classList.remove('shifted');
                }
            }

            // Event listeners
            sidebarToggle.addEventListener('click', toggleSidebar);
            sidebarOverlay.addEventListener('click', closeSidebar);

            // Close sidebar on escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && sidebarOpen) {
                    closeSidebar();
                }
            });

            // Handle window resize
            window.addEventListener('resize', function() {
                if (window.innerWidth <= 768 && sidebarOpen) {
                    mainContent.classList.remove('shifted');
                } else if (window.innerWidth > 768 && sidebarOpen) {
                    mainContent.classList.add('shifted');
                }
            });

            // Handle menu item clicks
            const menuLinks = document.querySelectorAll('.sidebar-menu-link');
            
            // HOME menu functionality
            document.getElementById('homeMenu').addEventListener('click', function(e) {
                e.preventDefault();
                setActiveMenu(this);
                
                // Scroll to top smoothly
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
                
                // Close sidebar on mobile
                if (window.innerWidth <= 768) {
                    closeSidebar();
                }
                
                console.log('Menu clicked: HOME - Scrolling to top');
            });
            
            // Dashboard menu functionality
            document.getElementById('dashboardMenu').addEventListener('click', function(e) {
                e.preventDefault();
                setActiveMenu(this);
                
                // Check if analysis results exist before navigating to dashboard
                const anovaResults = sessionStorage.getItem('anovaResults');
                
                if (anovaResults) {
                    // Navigate to dashboard page
                    window.location.href = '/dashboard';
                } else {
                    // Show message if no analysis results
                    showError('Please complete an ANOVA analysis first before viewing the dashboard.');
                }
                
                // Close sidebar on mobile
                if (window.innerWidth <= 768) {
                    closeSidebar();
                }
                
                console.log('Menu clicked: Dashboard');
            });
            
            // Export menu functionality
            document.getElementById('exportMenu').addEventListener('click', function(e) {
                e.preventDefault();
                setActiveMenu(this);
                
                // Check if analysis results exist before exporting
                const anovaResults = sessionStorage.getItem('anovaResults');
                
                if (anovaResults) {
                    // Trigger export modal (reuse existing export functionality)
                    showExportModal();
                } else {
                    // Show message if no analysis results
                    showError('Please complete an ANOVA analysis first before exporting results.');
                }
                
                // Close sidebar on mobile
                if (window.innerWidth <= 768) {
                    closeSidebar();
                }
                
                console.log('Menu clicked: Export');
            });
            
            // Results menu functionality
            document.getElementById('resultsMenu').addEventListener('click', function(e) {
                e.preventDefault();
                setActiveMenu(this);
                
                // Toggle results panel
                toggleResultsPanel();
                
                // Close sidebar on mobile
                if (window.innerWidth <= 768) {
                    closeSidebar();
                }
                
                console.log('Menu clicked: Results');
            });
            
            // Helper function to set active menu
            function setActiveMenu(activeElement) {
                menuLinks.forEach(link => link.classList.remove('active'));
                activeElement.classList.add('active');
            }
            
            // Show export modal function (reuse existing functionality)
            function showExportModal() {
                // Check if export button exists and trigger its functionality
                const exportBtn = document.getElementById('exportBtn');
                if (exportBtn) {
                    exportBtn.click();
                } else {
                    // Create a simple export options dialog
                    const modal = document.createElement('div');
                    modal.className = 'export-modal';
                    modal.innerHTML = `
                        <div class="export-modal-overlay" onclick="closeExportModal()"></div>
                        <div class="export-modal-content">
                            <div class="export-modal-header">
                                <h3>Export Analysis Results</h3>
                                <button class="export-modal-close" onclick="closeExportModal()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="export-modal-body">
                                <div class="export-options">
                                    <button class="btn btn-export" onclick="exportToPDF()">
                                        <i class="fas fa-file-pdf"></i>
                                        Export to PDF
                                    </button>
                                    <button class="btn btn-export" onclick="exportToPowerPoint()">
                                        <i class="fas fa-file-powerpoint"></i>
                                        Export to PowerPoint
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(modal);
                    
                    // Add modal styles if not exists
                    if (!document.getElementById('exportModalStyles')) {
                        const style = document.createElement('style');
                        style.id = 'exportModalStyles';
                        style.textContent = `
                            .export-modal {
                                position: fixed;
                                top: 0;
                                left: 0;
                                width: 100%;
                                height: 100%;
                                z-index: 2000;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                            }
                            .export-modal-overlay {
                                position: absolute;
                                top: 0;
                                left: 0;
                                width: 100%;
                                height: 100%;
                                background: rgba(0, 0, 0, 0.5);
                            }
                            .export-modal-content {
                                background: var(--bg-card);
                                border-radius: var(--radius);
                                padding: 24px;
                                max-width: 400px;
                                width: 90%;
                                z-index: 1;
                                box-shadow: var(--shadow-lg);
                            }
                            .export-modal-header {
                                display: flex;
                                justify-content: space-between;
                                align-items: center;
                                margin-bottom: 20px;
                                padding-bottom: 12px;
                                border-bottom: 1px solid var(--border-color);
                            }
                            .export-modal-close {
                                background: none;
                                border: none;
                                font-size: 1.5rem;
                                cursor: pointer;
                                color: var(--text-secondary);
                            }
                            .export-options {
                                display: flex;
                                flex-direction: column;
                                gap: 15px;
                            }
                        `;
                        document.head.appendChild(style);
                    }
                }
            }
            
            // Close export modal function
            function closeExportModal() {
                const modal = document.querySelector('.export-modal');
                if (modal) {
                    modal.remove();
                }
            }
            
            // Export functions (reuse existing ones if available)
            function exportToPDF() {
                closeExportModal();
                const anovaResults = JSON.parse(sessionStorage.getItem('anovaResults'));
                
                fetch('/export_pdf', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        result: anovaResults,
                        rawData: anovaResults.basicInfo?.rawGroups || {}
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const link = document.createElement('a');
                        link.href = data.file_url;
                        link.download = data.filename;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        showSuccess('PDF exported successfully!');
                    } else {
                        showError('Failed to export PDF: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Export error:', error);
                    showError('Error exporting PDF. Please try again.');
                });
            }
            
            function exportToPowerPoint() {
                closeExportModal();
                const anovaResults = JSON.parse(sessionStorage.getItem('anovaResults'));
                
                fetch('/export_powerpoint', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        result: anovaResults,
                        rawData: anovaResults.basicInfo?.rawGroups || {}
                    })
                })
                .then(response => response.blob())
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = 'ANOVA_Analysis_Report.pptx';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(url);
                    showSuccess('PowerPoint exported successfully!');
                })
                .catch(error => {
                    console.error('Export error:', error);
                    showError('Error exporting PowerPoint. Please try again.');
                });
            }

            // Results Panel Variables
            let resultsPanelOpen = false;
            const resultsPanel = document.getElementById('resultsPanel');
            const resultsOverlay = document.getElementById('resultsOverlay');
            const resultsClose = document.getElementById('resultsClose');
            const resultsMessage = document.getElementById('resultsMessage');
            const resultsLinks = document.getElementById('resultsLinks');

            // Results Panel Functions
            function toggleResultsPanel() {
                resultsPanelOpen = !resultsPanelOpen;
                
                if (resultsPanelOpen) {
                    resultsPanel.classList.add('open');
                    resultsOverlay.classList.add('show');
                    
                    // Check if analysis data is available
                    const anovaResults = sessionStorage.getItem('anovaResults');
                    if (anovaResults) {
                        resultsMessage.style.display = 'none';
                        resultsLinks.classList.add('show');
                        updateResultsLinks();
                    } else {
                        resultsMessage.style.display = 'block';
                        resultsLinks.classList.remove('show');
                    }
                } else {
                    resultsPanel.classList.remove('open');
                    resultsOverlay.classList.remove('show');
                }
            }

            function closeResultsPanel() {
                if (resultsPanelOpen) {
                    resultsPanelOpen = false;
                    resultsPanel.classList.remove('open');
                    resultsOverlay.classList.remove('show');
                }
            }

            function updateResultsLinks() {
                const anovaResults = sessionStorage.getItem('anovaResults');
                if (!anovaResults) return;

                // Update link URLs to point to analysis routes
                const resultLinksElements = document.querySelectorAll('.results-link');
                resultLinksElements.forEach(link => {
                    const section = link.dataset.section;
                    link.href = `/analysis/${section}`;
                });
            }

            // Results panel event listeners
            resultsClose.addEventListener('click', closeResultsPanel);
            resultsOverlay.addEventListener('click', closeResultsPanel);

            // Handle results link clicks
            document.querySelectorAll('.results-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const section = this.dataset.section;
                    
                    // Check if analysis results exist
                    const anovaResults = sessionStorage.getItem('anovaResults');
                    if (anovaResults) {
                        // Navigate to analysis section
                        window.location.href = `/analysis/${section}`;
                    } else {
                        showError('Please complete an ANOVA analysis first.');
                    }
                    
                    closeResultsPanel();
                });
            });

            // Close results panel on escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && resultsPanelOpen) {
                    closeResultsPanel();
                }
            });
        });
    </script>
</body>
</html>